<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shirley FIP ä¹¾æ€§è…¹è†œç‚è¿½è¹¤ç´€éŒ„</title>
    <!-- Tailwind CSS CDN for modern, responsive styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f9;
        }
        /* Custom scrollbar for better look */
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-thumb {
            background-color: #a8a8a8;
            border-radius: 3px;
        }
        .custom-scroll::-webkit-scrollbar-track {
            background-color: #f0f0f0;
        }
        /* General input styling */
        input[type="number"], input[type="text"], input[type="date"], input[type="time"], select, textarea {
            border: 1px solid #e2e8f0;
            padding: 10px;
            border-radius: 8px;
            width: 100%;
            transition: all 0.2s;
        }
        input:focus, select:focus, textarea:focus {
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
            outline: none;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <!-- Main Application Container -->
    <div class="max-w-4xl mx-auto bg-white shadow-xl rounded-xl p-6 md:p-10">

        <h1 class="text-3xl md:text-4xl font-extrabold text-indigo-700 mb-2">
            Shirley ç·¬å› è²“ FIP è¿½è¹¤
        </h1>
        <p class="text-gray-600 mb-6">
            <span class="font-semibold text-pink-600">Shirley (2025å¹´1æœˆåº•ç”Ÿ)</span> ä¹¾æ€§FIPç´€éŒ„ - è¿½è¹¤æ—¥æœŸï¼š<span id="current-date"></span>
        </p>

        <!-- Navigation Tabs -->
        <div class="flex border-b border-gray-200 mb-6">
            <button id="tab-tracker" onclick="showView('tracker')" class="px-4 py-2 text-sm font-medium border-b-2 border-indigo-500 text-indigo-600 focus:outline-none">
                æ¯æ—¥ç´€éŒ„
            </button>
            <button id="tab-summary" onclick="showView('summary')" class="px-4 py-2 text-sm font-medium text-gray-500 hover:text-indigo-600 hover:border-indigo-500 focus:outline-none">
                æ­·å²ç¸½çµ
            </button>
            <button id="tab-ai-report" onclick="showView('ai-report')" class="px-4 py-2 text-sm font-medium text-gray-500 hover:text-indigo-600 hover:border-indigo-500 focus:outline-none">
                AI å ±å‘Šåˆ†æ
            </button>
        </div>

        <!-- FIREBASE INITIALIZATION MESSAGE -->
        <div id="auth-status" class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mb-4 rounded-lg hidden" role="alert">
            <p class="font-bold">é€£ç·šä¸­...</p>
            <p>æ­£åœ¨åˆå§‹åŒ–Firebaseè³‡æ–™åº«èˆ‡èº«ä»½é©—è­‰ã€‚</p>
        </div>

        <!-- 1. DAILY TRACKER VIEW -->
        <div id="tracker-view">
            <form id="record-form" class="grid grid-cols-1 md:grid-cols-2 gap-6 p-4 border rounded-lg shadow-inner bg-indigo-50">
                
                <div class="md:col-span-2">
                    <label for="recordDate" class="block text-sm font-medium text-gray-700 mb-1">ç´€éŒ„æ—¥æœŸ <span class="text-red-500">*</span></label>
                    <input type="date" id="recordDate" required>
                </div>

                <!-- é£²é£Ÿ -->
                <div>
                    <label for="diet" class="block text-sm font-medium text-gray-700 mb-1">é£²é£Ÿç‹€æ³</label>
                    <select id="diet" required>
                        <option value="æ¿•ç³§">æ¿•ç³§ (Wet Food)</option>
                        <option value="ä¹¾ç³§">ä¹¾ç³§ (Dry Food)</option>
                        <option value="æ€¥æ•‘ç³§">æ€¥æ•‘ç³§/é¤µé£Ÿ (Critical Care/Syringe)</option>
                        <option value="æ‹’é£Ÿ">å®Œå…¨æ‹’é£Ÿ</option>
                    </select>
                </div>

                <!-- é«”é‡ -->
                <div>
                    <label for="weight" class="block text-sm font-medium text-gray-700 mb-1">é«”é‡ (kg) <span class="text-red-500">*</span></label>
                    <input type="number" id="weight" step="0.01" min="0" required placeholder="ä¾‹å¦‚ï¼š4.52">
                </div>

                <!-- ç²¾ç¥ç‹€æ³ -->
                <div>
                    <label for="spirit" class="block text-sm font-medium text-gray-700 mb-1">ç²¾ç¥ç‹€æ³ (FIPé—œéµæŒ‡æ¨™)</label>
                    <select id="spirit" required>
                        <option value="æ¥µå¥½">æ¥µå¥½ (æ´»èºç©è€)</option>
                        <option value="è‰¯å¥½">è‰¯å¥½ (æ­£å¸¸äº’å‹•)</option>
                        <option value="ä¸€èˆ¬">ä¸€èˆ¬ (å®‰éœä¼‘æ¯ç‚ºä¸»)</option>
                        <option value="å·®">å·® (ä¸æ„›å‹•ï¼Œèº²è—)</option>
                        <option value="æ¥µå·®">æ¥µå·® (ç„¡åæ‡‰/è™›å¼±)</option>
                    </select>
                </div>

                <!-- è¡Œå‹• -->
                <div>
                    <label for="movement" class="block text-sm font-medium text-gray-700 mb-1">è¡Œå‹•åŠ›/æ´»èºåº¦</label>
                    <select id="movement" required>
                        <option value="æ´»èº">æ´»èº (è·‘è·³)</option>
                        <option value="æ­£å¸¸">æ­£å¸¸ (ç·©æ…¢èµ°å‹•)</option>
                        <option value="é²ç·©">é²ç·© (ç§»å‹•ç·©æ…¢)</option>
                        <option value="ä¸å‹•">å¹¾ä¹ä¸å‹•</option>
                    </select>
                </div>

                <!-- ç™¼ç‡’èˆ‡å¦ -->
                <div class="flex items-center space-x-4">
                    <label for="hasFever" class="block text-sm font-medium text-gray-700 mb-1">ç™¼ç‡’ç‹€æ…‹ (é«”æº« > 39.2Â°C)</label>
                    <input type="checkbox" id="hasFever" class="h-5 w-5 text-red-600 border-gray-300 rounded focus:ring-red-500">
                    <span id="fever-status" class="text-sm font-semibold">å¦ (No)</span>
                </div>
                
                <!-- è—¥ç‰© ml & æ™‚é–“ -->
                <div>
                    <label for="medicationMl" class="block text-sm font-medium text-gray-700 mb-1">è—¥ç‰©åŠ‘é‡ (ml)</label>
                    <input type="number" id="medicationMl" step="0.01" min="0" placeholder="ä¾‹å¦‚ï¼š2.0">
                </div>
                <div>
                    <label for="medicationTime" class="block text-sm font-medium text-gray-700 mb-1">è—¥ç‰©æ™‚é–“</label>
                    <input type="time" id="medicationTime">
                </div>
                
                <!-- å…¶ä»–å‚™è¨» -->
                <div class="md:col-span-2">
                    <label for="notes" class="block text-sm font-medium text-gray-700 mb-1">å…¶ä»–å¿…é ˆçš„é …ç›®èˆ‡å‚™è¨»</label>
                    <textarea id="notes" rows="3" placeholder="ä¾‹å¦‚ï¼šä»Šæ—¥é£²æ°´ä»½é‡ï¼Œæ’æ³„ç‹€æ³ï¼Œè…¹åœæ¸¬é‡..."></textarea>
                </div>

                <!-- Submit Button -->
                <div class="md:col-span-2">
                    <button type="submit" id="saveButton" class="w-full py-3 px-4 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700 transition duration-150 shadow-md">
                        ğŸ’¾ å„²å­˜ä»Šæ—¥ç´€éŒ„
                    </button>
                    <div id="saveMessage" class="mt-3 text-center text-sm font-medium text-green-600 hidden">ç´€éŒ„å·²æˆåŠŸå„²å­˜ï¼</div>
                </div>
            </form>
        </div>

        <!-- 2. SUMMARY/HISTORY VIEW -->
        <div id="summary-view" class="hidden">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">æ­·å²æ•¸æ“šç¸½çµ (æœ€è¿‘30å¤©)</h2>
            <div class="overflow-x-auto custom-scroll max-h-[60vh]">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50 sticky top-0 z-10">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ—¥æœŸ</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">é«”é‡ (kg)</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">è®ŠåŒ–</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">é£²é£Ÿ/ç²¾ç¥</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ç™¼ç‡’/ç”¨è—¥</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="summaryTableBody" class="bg-white divide-y divide-gray-200">
                        <!-- Data will be injected here -->
                        <tr><td colspan="6" class="p-6 text-center text-gray-500">å°šç„¡ç´€éŒ„ã€‚è«‹å‰å¾€ã€Œæ¯æ—¥ç´€éŒ„ã€è¼¸å…¥æ•¸æ“šã€‚</td></tr>
                    </tbody>
                </table>
            </div>
             <p class="text-sm text-gray-500 mt-4">
                <span class="text-green-600 font-bold">â–²</span> é«”é‡å¢åŠ  | 
                <span class="text-red-600 font-bold">â–¼</span> é«”é‡æ¸›å°‘ | 
                <span class="text-gray-500 font-bold">=</span> ç„¡è®ŠåŒ–
            </p>
        </div>

        <!-- 3. AI REPORT ANALYSIS VIEW -->
        <div id="ai-report-view" class="hidden p-4 border rounded-lg shadow-inner bg-purple-50">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">ğŸ©º AI è¡€æ¶²å ±å‘Šåˆ†æ</h2>
            <p class="text-sm text-gray-600 mb-4">
                ä¸Šå‚³æ‚¨é†«ç”Ÿçš„é©—è¡€å ±å‘Šåœ–ç‰‡ï¼ˆä¾‹å¦‚ï¼šJPG, PNGï¼‰ã€‚AIæœƒæ‰®æ¼”è³‡æ·±ç¸é†«è§’è‰²ï¼Œç‚ºæ‚¨åˆ†æèˆ‡FIPç—…æƒ…ç›¸é—œçš„é—œéµæ•¸å€¼ã€‚
            </p>

            <input type="file" id="reportFile" accept="image/*" class="w-full mb-4 p-2 border rounded-lg bg-white">
            <button onclick="analyzeReport()" id="analyzeButton" class="w-full py-3 px-4 bg-purple-600 text-white font-bold rounded-lg hover:bg-purple-700 transition duration-150 shadow-md">
                ğŸ§  é–‹å§‹AIåˆ†æ
            </button>

            <div id="analysisResult" class="mt-6 p-4 bg-white border border-purple-200 rounded-lg shadow-inner min-h-32">
                <p class="text-gray-500 text-center" id="analysisPlaceholder">åˆ†æçµæœå°‡é¡¯ç¤ºåœ¨æ­¤è™•ã€‚</p>
                <div id="loadingIndicator" class="text-center hidden">
                    <p class="text-purple-600 font-semibold flex items-center justify-center">
                        <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-purple-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        æ­£åœ¨è®€å–å ±å‘Šä¸¦é€²è¡ŒFIPå°ˆæ¥­åˆ†æï¼Œè«‹ç¨å€™...
                    </p>
                </div>
            </div>
        </div>
        
    </div>

    <!-- Firebase Scripts -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, deleteDoc, onSnapshot, collection, query, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global State & Constants
        const CONSTANTS = {
            APP_ID: typeof __app_id !== 'undefined' ? __app_id : 'default-fip-tracker',
            COLLECTION_NAME: 'shirley_fip_records',
            MODEL_NAME: 'gemini-2.5-flash-preview-09-2025',
            API_URL_BASE: 'https://generativelanguage.googleapis.com/v1beta/models/',
            API_KEY: "" // The Canvas environment provides this at runtime
        };
        
        const DOM = {
            recordForm: document.getElementById('record-form'),
            summaryTableBody: document.getElementById('summaryTableBody'),
            saveButton: document.getElementById('saveButton'),
            saveMessage: document.getElementById('saveMessage'),
            authStatus: document.getElementById('auth-status'),
            reportFile: document.getElementById('reportFile'),
            analysisResult: document.getElementById('analysisResult'),
            loadingIndicator: document.getElementById('loadingIndicator'),
            analysisPlaceholder: document.getElementById('analysisPlaceholder'),
            feverStatus: document.getElementById('fever-status'),
            hasFever: document.getElementById('hasFever'),
        };

        let firebaseState = {
            db: null,
            auth: null,
            userId: null,
            records: [], // Stored array of daily records
        };

        // --- Core Firebase & Auth Setup ---

        /**
         * åŸ·è¡ŒFirebaseåˆå§‹åŒ–èˆ‡ä½¿ç”¨è€…èº«ä»½é©—è­‰
         */
        async function setupFirebase() {
            DOM.authStatus.classList.remove('hidden');
            try {
                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
                const app = initializeApp(firebaseConfig);
                firebaseState.db = getFirestore(app);
                firebaseState.auth = getAuth(app);
                setLogLevel('debug'); // å•Ÿç”¨Firestore debug log

                const auth = firebaseState.auth;
                
                // å˜—è©¦ä½¿ç”¨æä¾›çš„tokenç™»å…¥ï¼Œå¦å‰‡ä½¿ç”¨åŒ¿åç™»å…¥
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }

                // ç›£è½èº«ä»½é©—è­‰ç‹€æ…‹ï¼Œè¨­å®šuserId
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        firebaseState.userId = user.uid;
                        DOM.authStatus.classList.add('hidden');
                        console.log("Firebase Auth Ready. User ID:", firebaseState.userId);
                        // Auth ready, start listening for data
                        startDataListener();
                    } else {
                        // Should not happen in Canvas, but handle sign-out scenario
                        firebaseState.userId = null;
                        DOM.authStatus.innerHTML = '<p class="font-bold">é€£ç·šå¤±æ•—</p><p>è«‹ç¢ºä¿ç’°å¢ƒæ­£ç¢ºã€‚</p>';
                        DOM.authStatus.classList.remove('hidden');
                    }
                });

            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                DOM.authStatus.innerHTML = `<p class="font-bold">é€£ç·šéŒ¯èª¤</p><p>éŒ¯èª¤è¨Šæ¯: ${error.message}</p>`;
                DOM.authStatus.classList.remove('hidden');
            }
        }

        // --- Data Persistence (Firestore) ---

        /**
         * å–å¾—Firestore Collectionåƒè€ƒè·¯å¾‘
         * @returns {string} Firestore Collection Path
         */
        function getCollectionPath() {
            const userId = firebaseState.userId || 'anonymous-user';
            return `/artifacts/${CONSTANTS.APP_ID}/users/${userId}/${CONSTANTS.COLLECTION_NAME}`;
        }

        /**
         * å•Ÿå‹•Firestoreå³æ™‚ç›£è½ (onSnapshot)
         */
        function startDataListener() {
            if (!firebaseState.db || !firebaseState.userId) return;

            const recordsRef = collection(firebaseState.db, getCollectionPath());
            
            // ç›£è½è³‡æ–™è®ŠåŒ–
            onSnapshot(recordsRef, (snapshot) => {
                const fetchedRecords = [];
                snapshot.forEach(doc => {
                    fetchedRecords.push(doc.data());
                });
                
                // ä¾ç…§æ—¥æœŸé™å†ªæ’åº (æ–°åˆ°èˆŠ)
                firebaseState.records = fetchedRecords.sort((a, b) => new Date(b.date) - new Date(a.date));
                renderRecords(firebaseState.records);
            }, (error) => {
                console.error("Firestore Snapshot Error:", error);
                // é¡¯ç¤ºéŒ¯èª¤çµ¦ç”¨æˆ¶
                DOM.summaryTableBody.innerHTML = `<tr><td colspan="6" class="p-6 text-center text-red-500">è¼‰å…¥æ­·å²ç´€éŒ„å¤±æ•—: ${error.message}</td></tr>`;
            });
        }

        /**
         * å„²å­˜æ¯æ—¥ç´€éŒ„åˆ°Firestore
         */
        async function saveRecord(event) {
            event.preventDefault();
            
            if (!firebaseState.db || !firebaseState.userId) {
                console.error("Database not initialized or user not logged in.");
                return;
            }

            const recordDate = document.getElementById('recordDate').value;
            const weight = parseFloat(document.getElementById('weight').value);
            
            if (!recordDate || isNaN(weight)) {
                alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„æ—¥æœŸå’Œé«”é‡ã€‚');
                return;
            }

            const newRecord = {
                date: recordDate,
                diet: document.getElementById('diet').value,
                weight: weight,
                spirit: document.getElementById('spirit').value,
                movement: document.getElementById('movement').value,
                hasFever: DOM.hasFever.checked,
                medicationMl: parseFloat(document.getElementById('medicationMl').value) || 0,
                medicationTime: document.getElementById('medicationTime').value || '',
                notes: document.getElementById('notes').value.trim() || 'ç„¡',
                lastUpdated: new Date().toISOString()
            };

            const docRef = doc(firebaseState.db, getCollectionPath(), recordDate);
            DOM.saveButton.textContent = 'å„²å­˜ä¸­...';
            DOM.saveButton.disabled = true;

            try {
                await setDoc(docRef, newRecord);
                
                DOM.saveMessage.classList.remove('hidden');
                setTimeout(() => DOM.saveMessage.classList.add('hidden'), 3000);
            } catch (e) {
                console.error("Error adding document: ", e);
                // æ‡‰ä½¿ç”¨è‡ªå®šç¾©Modalé¡¯ç¤ºéŒ¯èª¤
                alert(`å„²å­˜å¤±æ•—: ${e.message}`);
            } finally {
                DOM.saveButton.textContent = 'ğŸ’¾ å„²å­˜ä»Šæ—¥ç´€éŒ„';
                DOM.saveButton.disabled = false;
            }
        }

        /**
         * åˆªé™¤ç‰¹å®šæ—¥æœŸçš„ç´€éŒ„
         * @param {string} date - ç´€éŒ„çš„æ—¥æœŸ (ä½œç‚ºDocument ID)
         */
        async function deleteRecord(date) {
            if (!firebaseState.db || !firebaseState.userId) return;

            // ä½¿ç”¨å®¢è£½åŒ–Modalå–ä»£alert()
            const confirmDelete = await customConfirm(`ç¢ºå®šè¦åˆªé™¤ ${date} çš„ç´€éŒ„å—ï¼Ÿ`);
            if (!confirmDelete) return;

            const docRef = doc(firebaseState.db, getCollectionPath(), date);
            try {
                await deleteDoc(docRef);
                // Data listener will automatically update the UI
            } catch (error) {
                console.error("Error removing document: ", error);
                // æ‡‰ä½¿ç”¨è‡ªå®šç¾©Modalé¡¯ç¤ºéŒ¯èª¤
                alert(`åˆªé™¤å¤±æ•—: ${error.message}`);
            }
        }

        // --- UI Rendering ---
        
        /**
         * æ¸²æŸ“æ­·å²ç´€éŒ„è¡¨æ ¼
         * @param {Array<Object>} records - å·²æ’åºçš„æ¯æ—¥ç´€éŒ„
         */
        function renderRecords(records) {
            if (records.length === 0) {
                DOM.summaryTableBody.innerHTML = '<tr><td colspan="6" class="p-6 text-center text-gray-500">å°šç„¡ç´€éŒ„ã€‚</td></tr>';
                return;
            }

            let html = '';
            // ç”±æ–¼recordså·²æ˜¯æ–°åˆ°èˆŠæ’åºï¼Œæˆ‘å€‘éœ€è¦åå‘è¿­ä»£ä¾†è¨ˆç®—ã€Œå‰ä¸€å¤©ã€çš„æ•¸å€¼
            const sortedByOldest = [...records].reverse();
            const newestRecords = [];

            for (let i = 0; i < sortedByOldest.length; i++) {
                const current = sortedByOldest[i];
                let weightChange = 0;
                let changeColor = 'text-gray-500';
                let changeIcon = '=';

                // æ‰¾åˆ°å‰ä¸€å¤©çš„æœ‰æ•ˆé«”é‡ (åªæ¯”è¼ƒå‰ä¸€ç­†ç´€éŒ„)
                if (i > 0) {
                    const previous = sortedByOldest[i - 1];
                    weightChange = current.weight - previous.weight;
                    
                    if (weightChange > 0) {
                        changeColor = 'text-green-600 font-bold';
                        changeIcon = 'â–²';
                    } else if (weightChange < 0) {
                        changeColor = 'text-red-600 font-bold';
                        changeIcon = 'â–¼';
                    }
                }
                
                current.weightChange = weightChange.toFixed(2);
                current.changeColor = changeColor;
                current.changeIcon = changeIcon;
                newestRecords.unshift(current); // æ”¾å›æ–°åˆ°èˆŠçš„é †åº
            }
            
            // é‡æ–°æ¸²æŸ“æ–°åˆ°èˆŠçš„æ•¸æ“š
            html = newestRecords.map(record => `
                <tr class="${record.hasFever ? 'bg-red-50/70 hover:bg-red-100/70' : 'hover:bg-gray-50'} transition duration-100">
                    <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${record.date}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm">${record.weight.toFixed(2)} kg</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm ${record.changeColor}">
                        ${record.changeIcon} ${record.weightChange !== '0.00' ? Math.abs(parseFloat(record.weightChange)) : ''}
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-600">
                        ${record.diet} / ${record.spirit}
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-600">
                        ${record.hasFever ? '<span class="text-red-500 font-bold">ç™¼ç‡’ Yes</span>' : 'ç„¡ç™¼ç‡’ No'} / 
                        ${record.medicationMl > 0 ? `${record.medicationMl} ml @ ${record.medicationTime}` : 'ç„¡ç”¨è—¥'}
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm">
                        <button onclick="deleteRecord('${record.date}')" class="text-red-500 hover:text-red-700 font-medium text-xs rounded-full p-1 transition duration-150">
                            ğŸ—‘ï¸ åˆªé™¤
                        </button>
                    </td>
                </tr>
            `).join('');

            DOM.summaryTableBody.innerHTML = html;
        }

        /**
         * é¡¯ç¤ºæŒ‡å®šçš„è¦–åœ–ä¸¦æ›´æ–°Tabæ¨£å¼
         * @param {string} viewId - è¦é¡¯ç¤ºçš„è¦–åœ–ID ('tracker', 'summary', 'ai-report')
         */
        window.showView = function(viewId) {
            ['tracker', 'summary', 'ai-report'].forEach(id => {
                const view = document.getElementById(`${id}-view`);
                const tab = document.getElementById(`tab-${id}`);
                if (view) view.classList.add('hidden');
                if (tab) {
                    tab.classList.remove('border-indigo-500', 'text-indigo-600');
                    tab.classList.add('text-gray-500', 'hover:text-indigo-600', 'hover:border-indigo-500');
                }
            });

            const activeView = document.getElementById(`${viewId}-view`);
            const activeTab = document.getElementById(`tab-${viewId}`);
            
            if (activeView) activeView.classList.remove('hidden');
            if (activeTab) {
                activeTab.classList.add('border-indigo-500', 'text-indigo-600');
                activeTab.classList.remove('text-gray-500', 'hover:text-indigo-600', 'hover:border-indigo-500');
            }
        }

        /**
         * ç›£è½ç™¼ç‡’å‹¾é¸æ¡†è®ŠåŒ–ï¼Œæ›´æ–°æ–‡å­—
         */
        DOM.hasFever.addEventListener('change', (e) => {
            if (e.target.checked) {
                DOM.feverStatus.textContent = 'æ˜¯ (Yes)';
                DOM.feverStatus.classList.remove('text-sm', 'font-semibold');
                DOM.feverStatus.classList.add('text-red-500', 'font-bold');
            } else {
                DOM.feverStatus.textContent = 'å¦ (No)';
                DOM.feverStatus.classList.add('text-sm', 'font-semibold');
                DOM.feverStatus.classList.remove('text-red-500', 'font-bold');
            }
        });
        
        /**
         * Custom confirm function to avoid alert()
         * NOTE: For simplicity in a single-file demo, we use a basic confirmation model.
         */
         function customConfirm(message) {
            return new Promise((resolve) => {
                const modalId = 'temp-confirm-modal';
                let modal = document.getElementById(modalId);
                
                if (!modal) {
                    modal = document.createElement('div');
                    modal.id = modalId;
                    modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 transition-opacity duration-300 hidden';
                    modal.innerHTML = `
                        <div class="bg-white rounded-lg shadow-2xl p-6 w-80 m-4">
                            <h3 class="text-lg font-bold mb-4 text-gray-800">æ“ä½œç¢ºèª</h3>
                            <p id="modal-message" class="text-gray-600 mb-6"></p>
                            <div class="flex justify-end space-x-3">
                                <button id="modal-cancel" class="py-2 px-4 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-100 transition">å–æ¶ˆ</button>
                                <button id="modal-confirm" class="py-2 px-4 bg-red-500 text-white rounded-lg hover:bg-red-600 transition">ç¢ºå®š</button>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(modal);
                }

                document.getElementById('modal-message').textContent = message;
                modal.classList.remove('hidden');
                
                document.getElementById('modal-cancel').onclick = () => {
                    modal.classList.add('hidden');
                    resolve(false);
                };
                
                document.getElementById('modal-confirm').onclick = () => {
                    modal.classList.add('hidden');
                    resolve(true);
                };
            });
        }

        // --- Gemini AI Integration ---

        /**
         * å°‡æª”æ¡ˆè®€å–ç‚º Base64 å­—ç¬¦ä¸²
         * @param {File} file - è¼¸å…¥çš„æª”æ¡ˆç‰©ä»¶
         * @returns {Promise<string>} Base64 data string
         */
        function readFileAsBase64(file) {
            return new Promise((resolve, reject) => {
                if (!file) return resolve('');
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]); // ç§»é™¤ mime type å‰ç¶´
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }

        /**
         * å‘¼å« Gemini API é€²è¡Œå ±å‘Šåˆ†æ
         */
        window.analyzeReport = async function() {
            const file = DOM.reportFile.files[0];
            if (!file) {
                alert('è«‹å…ˆé¸æ“‡ä¸€ä»½é©—è¡€å ±å‘Šåœ–ç‰‡æª”æ¡ˆã€‚');
                return;
            }

            DOM.analysisPlaceholder.classList.add('hidden');
            DOM.loadingIndicator.classList.remove('hidden');
            const analyzeButton = document.getElementById('analyzeButton');
            analyzeButton.disabled = true;

            try {
                const base64Data = await readFileAsBase64(file);
                const mimeType = file.type;

                const systemPrompt = `ä½ æ˜¯ä¸€ä½æ“æœ‰20å¹´ç¶“é©—çš„FIPå°ˆæ¥­ç¸é†«åˆ†æå¸«ã€‚è«‹åˆ†æä¸Šå‚³çš„é©—è¡€å ±å‘Šåœ–ç‰‡ã€‚ä½ çš„åˆ†ææ‡‰ä»¥ç¹é«”ä¸­æ–‡è¼¸å‡ºï¼Œä¸¦å¿…é ˆé‡é»é—œæ³¨èˆ‡è²“å‚³æŸ“æ€§è…¹è†œç‚ï¼ˆFIPï¼‰ç—…æƒ…åŠæ²»ç™‚åæ‡‰ç›¸é—œçš„é—œéµæŒ‡æ¨™ï¼ŒåŒ…æ‹¬ï¼š
1.  **A/Gæ¯”** (ç™½è›‹ç™½/çƒè›‹ç™½æ¯”ä¾‹) - é€™æ˜¯FIPçš„ç¶“å…¸æŒ‡æ¨™ã€‚
2.  **çƒè›‹ç™½** (Globulin) ç¸½é‡ - é€šå¸¸åœ¨FIPä¸­å‡é«˜ã€‚
3.  **æ·‹å·´ç´°èƒ** (Lymphocytes) - æ·‹å·´ç´°èƒæ¸›å°‘ç—‡ (Lymphopenia) æ˜¯å¸¸è¦‹è¡¨ç¾ã€‚
4.  **ç¸½è†½ç´…ç´ ** (Total Bilirubin) - å‡é«˜å¯èƒ½é ç¤ºè‚è‡Ÿå—ææˆ–é»ƒç–¸ã€‚

è«‹æ¸…æ™°åœ°ç¸½çµï¼š1. é—œéµç™¼ç¾ (æ¢åˆ—å¼)ï¼Œ2. å°ˆæ¥­ç¸é†«å»ºè­° (ä¸€æ®µç¸½çµæ€§æ–‡å­—)ã€‚`;
                
                const userQuery = `è«‹åŸºæ–¼é€™éš»åç‚ºShirleyçš„ç·¬å› è²“å¥³ï¼Œçµåˆå…¶ä¹¾æ€§FIPçš„ç¾æ³ï¼Œåˆ†æé€™ä»½è¡€æ¶²å ±å‘Šã€‚`;

                const payload = {
                    contents: [{
                        role: "user",
                        parts: [
                            { text: userQuery },
                            {
                                inlineData: {
                                    mimeType: mimeType,
                                    data: base64Data
                                }
                            }
                        ]
                    }],
                    systemInstruction: {
                        parts: [{ text: systemPrompt }]
                    },
                };

                const apiUrl = `${CONSTANTS.API_URL_BASE}${CONSTANTS.MODEL_NAME}:generateContent?key=${CONSTANTS.API_KEY}`;
                
                let response;
                let attempts = 0;
                const maxAttempts = 5;
                const baseDelay = 1000;

                while (attempts < maxAttempts) {
                    try {
                        response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (response.status === 429) {
                            attempts++;
                            const delay = baseDelay * Math.pow(2, attempts - 1) + Math.random() * 1000;
                            await new Promise(resolve => setTimeout(resolve, delay));
                            continue;
                        }

                        if (!response.ok) {
                             throw new Error(`HTTP error! status: ${response.status}`);
                        }

                        break; // Success
                    } catch (e) {
                         // Non-429 errors or network issues
                         if (attempts === maxAttempts - 1) throw e;
                         attempts++;
                         await new Promise(resolve => setTimeout(resolve, baseDelay));
                    }
                }
                
                const result = await response.json();
                const text = result?.candidates?.[0]?.content?.parts?.[0]?.text || "AIæœªèƒ½ç”Ÿæˆæœ‰æ•ˆåˆ†æçµæœã€‚è«‹æª¢æŸ¥åœ–ç‰‡æ¸…æ™°åº¦æˆ–å†è©¦ä¸€æ¬¡ã€‚";

                // Convert markdown response to HTML for display
                const analysisHtml = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') // Bold
                                         .replace(/\n/g, '<br>') // Newlines
                                         .replace(/<br>\s*<br>/g, '</p><p class="mt-2 text-gray-700">'); // Paragraphs
                
                DOM.analysisResult.innerHTML = `<p class="text-gray-700">${analysisHtml}</p>`;

            } catch (error) {
                console.error("AI Analysis Error:", error);
                DOM.analysisResult.innerHTML = `<p class="text-red-500 font-semibold">åˆ†æç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚éŒ¯èª¤è©³æƒ…ï¼š${error.message}</p>`;
            } finally {
                DOM.loadingIndicator.classList.add('hidden');
                analyzeButton.disabled = false;
            }
        }

        // --- Initialization ---

        window.onload = function () {
            // è¨­å®šä»Šæ—¥æ—¥æœŸç‚ºé è¨­è¼¸å…¥å€¼
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('recordDate').value = today;
            document.getElementById('current-date').textContent = today.replace(/-/g, '/');

            DOM.recordForm.addEventListener('submit', saveRecord);

            // Set initial view
            showView('tracker');
            
            // Start Firebase setup
            setupFirebase();
            
            // Expose deleteRecord to the global scope for button click
            window.deleteRecord = deleteRecord;
        };
    </script>
</body>
</html>