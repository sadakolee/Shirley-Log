<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Shirley's FIP Care Journal</title>
    <!-- Tailwind CSS for rapid styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts: Rounded and Friendly -->
    <link href="https://fonts.googleapis.com/css2?family=Varela+Round&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Varela Round', 'sans-serif'],
                    },
                    colors: {
                        'brand-bg': '#fdf6f0', // Soft warm white
                        'brand-primary': '#e0989b', // Muted Rose
                        'brand-secondary': '#8fa89b', // Sage Green
                        'brand-accent': '#6b5b95', // Muted Purple
                        'state-good': '#55a666', // Green
                        'state-bad': '#d9534f', // Red
                        'food-wet': '#88b3c8',
                        'food-dry': '#e6c87f',
                        'food-treat': '#f4a261',
                        'food-sos': '#d62828',
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #fdf6f0; color: #4a4a4a; -webkit-tap-highlight-color: transparent; }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #e0989b; border-radius: 10px; }
        
        .card-shadow { box-shadow: 0 4px 20px rgba(0,0,0,0.05); }
        .slide-in { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        /* Disabled input styling */
        input:disabled { background-color: #e5e7eb; color: #9ca3af; cursor: not-allowed; }
    </style>
</head>
<body class="pb-24">

    <!-- Header / Profile -->
    <header class="bg-white p-6 rounded-b-3xl card-shadow sticky top-0 z-10">
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-4">
                <div class="w-16 h-16 rounded-full bg-brand-primary flex items-center justify-center text-white text-3xl shadow-md border-4 border-white">
                    ğŸ±
                </div>
                <div>
                    <h1 class="text-2xl font-bold text-gray-700">Shirley <span class="text-xs bg-brand-primary text-white px-2 py-0.5 rounded-full">FIP Fighter</span></h1>
                    <p class="text-sm text-gray-500">ç·¬å› è²“ (F) | ç”Ÿæ—¥: 2025/01/25</p>
                    <p class="text-xs text-brand-secondary font-bold mt-1" id="age-display"></p>
                </div>
            </div>
            <button onclick="exportData()" class="text-gray-400 hover:text-brand-primary" title="åŒ¯å‡ºç´€éŒ„">
                <i class="fas fa-file-export"></i>
            </button>
        </div>
        
        <!-- Quick Stats -->
        <div class="grid grid-cols-3 gap-2 mt-4 text-center">
            <div class="bg-blue-50 p-2 rounded-xl">
                <p class="text-xs text-gray-500">æ²»ç™‚å¤©æ•¸</p>
                <p class="font-bold text-brand-accent text-lg" id="day-counter">Day 0</p>
            </div>
            <div class="bg-green-50 p-2 rounded-xl">
                <p class="text-xs text-gray-500">æœ€æ–°é«”é‡</p>
                <p class="font-bold text-state-good text-lg" id="latest-weight">-- kg</p>
            </div>
            <div class="bg-pink-50 p-2 rounded-xl">
                <p class="text-xs text-gray-500">ä»Šæ—¥æ‰“é‡</p>
                <p class="font-bold text-brand-primary text-lg" id="today-med-status">æœªå®Œæˆ</p>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="p-4 max-w-2xl mx-auto">
        
        <!-- Add Button -->
        <button onclick="openModal()" class="w-full bg-brand-primary hover:bg-red-400 text-white font-bold py-4 rounded-2xl shadow-lg transform transition active:scale-95 flex items-center justify-center gap-2 mb-6">
            <i class="fas fa-plus-circle text-xl"></i> æ–°å¢ä»Šæ—¥è§€å¯Ÿç´€éŒ„
        </button>

        <!-- History Title -->
        <div class="flex justify-between items-end mb-4 px-2">
            <h2 class="text-xl font-bold text-gray-700">æ­·å²ç´€éŒ„</h2>
            <span class="text-xs text-gray-400">ç³»çµ±ä¿ç•™æœ€è¿‘ 90+ ç­†è³‡æ–™</span>
        </div>

        <!-- Records List -->
        <div id="records-container" class="space-y-4">
            <!-- Records will be injected here via JS -->
            <div class="text-center py-10 text-gray-400">
                <i class="fas fa-paw text-4xl mb-2 opacity-50"></i>
                <p>ç›®å‰é‚„æ²’æœ‰ç´€éŒ„ï¼Œè«‹é»æ“Šä¸Šæ–¹æŒ‰éˆ•æ–°å¢ï¼</p>
            </div>
        </div>
    </main>

    <!-- Modal Form (Hidden by default) -->
    <div id="entry-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-end sm:items-center justify-center backdrop-blur-sm">
        <div class="bg-white w-full max-w-lg h-[90vh] sm:h-auto sm:max-h-[90vh] sm:rounded-2xl rounded-t-3xl overflow-y-auto slide-in flex flex-col">
            
            <!-- Modal Header -->
            <div class="flex justify-between items-center p-4 border-b sticky top-0 bg-white z-10">
                <h3 class="text-lg font-bold" id="modal-title">ğŸ“ è¨˜éŒ„ Shirley çš„ç‹€æ³</h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 w-8 h-8 flex items-center justify-center rounded-full bg-gray-100">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <!-- Form -->
            <form id="care-form" onsubmit="saveRecord(event)" class="p-5 space-y-6">
                <input type="hidden" id="record-id">
                
                <!-- Date & Time -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">æ—¥æœŸ</label>
                        <input type="date" id="date" required class="w-full bg-gray-50 border-0 rounded-xl p-3 focus:ring-2 focus:ring-brand-primary">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">æ™‚é–“</label>
                        <input type="time" id="time" required class="w-full bg-gray-50 border-0 rounded-xl p-3 focus:ring-2 focus:ring-brand-primary">
                    </div>
                </div>

                <!-- Critical Stats -->
                <div class="bg-blue-50 p-4 rounded-xl border border-blue-100">
                    <h4 class="text-blue-800 font-bold text-sm mb-3"><i class="fas fa-heartbeat mr-1"></i> é—œéµæŒ‡æ¨™</h4>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">é«”é‡ (kg)</label>
                            <input type="number" step="0.01" id="weight" placeholder="0.00" required class="w-full text-center text-lg font-bold bg-white border-0 rounded-xl p-2 shadow-sm focus:ring-2 focus:ring-brand-primary">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">é«”æº« (Â°C)</label>
                            <input type="number" step="0.1" id="temperature" placeholder="38.x" class="w-full text-center text-lg font-bold bg-white border-0 rounded-xl p-2 shadow-sm focus:ring-2 focus:ring-brand-primary transition-colors">
                            
                            <!-- No Fever Checkbox -->
                            <div class="flex items-center mt-2 p-1 bg-white rounded-lg border border-blue-100">
                                <input type="checkbox" id="temp_normal_feel" onchange="toggleTemperatureInput(this)" class="ml-1 h-4 w-4 text-state-good rounded border-gray-300 focus:ring-state-good">
                                <label for="temp_normal_feel" class="ml-2 text-xs text-gray-600 font-bold cursor-pointer select-none">æ‘¸è½ç„¡ç™¼ç‡’ (Default 38.5)</label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Food (Updated with split fields) -->
                <div class="space-y-3">
                    <label class="block text-sm font-bold text-gray-700 border-l-4 border-brand-secondary pl-2">é£²é£Ÿæ”å–</label>
                    <div class="grid grid-cols-4 gap-2">
                        <div>
                            <label class="text-xs text-gray-500 block text-center mb-1">æ¿•ç³§(g)</label>
                            <input type="number" id="food_wet" class="w-full text-center bg-gray-50 rounded-lg p-2 focus:ring-1 focus:ring-brand-secondary">
                        </div>
                        <div>
                            <label class="text-xs text-gray-500 block text-center mb-1">ä¹¾ç³§(g)</label>
                            <input type="number" id="food_dry" class="w-full text-center bg-gray-50 rounded-lg p-2 focus:ring-1 focus:ring-brand-secondary">
                        </div>
                        <div>
                            <label class="text-xs text-gray-500 block text-center mb-1">é›¶é£Ÿ(g)</label>
                            <input type="number" id="food_treats" class="w-full text-center bg-gray-50 rounded-lg p-2 focus:ring-1 focus:ring-brand-secondary">
                        </div>
                        <div>
                            <label class="text-xs text-gray-500 block text-center mb-1 text-red-400">æ€¥æ•‘(g)</label>
                            <input type="number" id="food_sos" class="w-full text-center bg-red-50 text-red-600 font-bold rounded-lg p-2 focus:ring-1 focus:ring-red-300">
                        </div>
                    </div>
                </div>

                <!-- Medications -->
                <div class="space-y-3">
                    <label class="block text-sm font-bold text-gray-700 border-l-4 border-brand-primary pl-2">è—¥ç‰©ç´€éŒ„</label>
                    
                    <!-- FIP Meds -->
                    <div class="bg-gray-50 p-3 rounded-xl flex items-center justify-between border border-gray-200">
                        <div>
                            <p class="font-bold text-sm text-brand-primary">FIP æŠ—ç—…æ¯’é‡åŠ‘ (GS)</p>
                            <input type="time" id="meds_fip_time" class="text-xs bg-transparent border-b border-gray-300 mt-1">
                        </div>
                        <div class="flex flex-col items-end gap-1">
                            <span class="text-[10px] text-gray-400">åŠ‘é‡ (ml)</span>
                            <input type="number" step="0.1" id="meds_fip_amount" placeholder="0.0" class="w-20 p-2 rounded-lg border-2 border-brand-primary/20 text-right font-bold text-brand-primary focus:border-brand-primary outline-none">
                        </div>
                    </div>

                    <!-- Other Meds Toggles -->
                    <div class="grid grid-cols-2 gap-3">
                        <label class="flex items-center space-x-2 bg-gray-50 p-3 rounded-xl cursor-pointer">
                            <input type="checkbox" id="meds_anemia" class="form-checkbox h-5 w-5 text-brand-primary rounded">
                            <span class="text-sm">è£œè¡€è—¥/å€è£œè¡€</span>
                        </label>
                        <label class="flex items-center space-x-2 bg-gray-50 p-3 rounded-xl cursor-pointer">
                            <input type="checkbox" id="meds_immune" class="form-checkbox h-5 w-5 text-brand-primary rounded">
                            <span class="text-sm">å…ç–«åŠ›è—¥/ä¸¹è«¾</span>
                        </label>
                    </div>

                    <!-- Appetite Stimulant (Ear) -->
                    <div class="bg-gray-50 p-3 rounded-xl">
                        <p class="text-sm mb-2">é–‹èƒƒè—¥ (Mirtazapine) å¡—æŠ¹ä½ç½®</p>
                        <div class="flex gap-2">
                            <label class="flex-1 cursor-pointer">
                                <input type="radio" name="appetite_ear" value="none" checked class="peer sr-only">
                                <div class="text-center py-2 bg-white border peer-checked:bg-gray-200 rounded-lg text-xs transition-colors">ç„¡ä½¿ç”¨</div>
                            </label>
                            <label class="flex-1 cursor-pointer">
                                <input type="radio" name="appetite_ear" value="left" class="peer sr-only">
                                <div class="text-center py-2 bg-white border peer-checked:bg-brand-secondary peer-checked:text-white rounded-lg text-xs transition-colors">å·¦è€³ (L)</div>
                            </label>
                            <label class="flex-1 cursor-pointer">
                                <input type="radio" name="appetite_ear" value="right" class="peer sr-only">
                                <div class="text-center py-2 bg-white border peer-checked:bg-brand-secondary peer-checked:text-white rounded-lg text-xs transition-colors">å³è€³ (R)</div>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Observations -->
                <div class="space-y-3 pb-6">
                    <label class="block text-sm font-bold text-gray-700 border-l-4 border-brand-accent pl-2">ç‹€æ…‹è§€å¯Ÿ</label>
                    
                    <div class="grid grid-cols-1 gap-4">
                        <!-- Sliders -->
                        <div>
                            <div class="flex justify-between text-xs mb-1">
                                <span>ç²¾ç¥ (1=æ¥µå·®, 5=æ¥µå¥½)</span>
                                <span id="val-mood" class="font-bold text-brand-accent">3</span>
                            </div>
                            <input type="range" id="mood" min="1" max="5" value="3" class="w-full accent-brand-accent" oninput="document.getElementById('val-mood').innerText = this.value">
                        </div>
                        
                        <!-- Selects for Dry FIP Neuro Signs -->
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="text-xs text-gray-500 block mb-1">è¡Œå‹•åŠ›</label>
                                <select id="mobility" class="w-full bg-gray-50 border-0 rounded-lg p-2 text-sm">
                                    <option value="normal">æ­£å¸¸è·‘è·³</option>
                                    <option value="slow">ç·©æ…¢ä½†å¯è¡Œèµ°</option>
                                    <option value="wobbly">å¾Œè…³ç„¡åŠ›/æ–æ™ƒ</option>
                                    <option value="dragging">æ‹–è¡Œ/ç„¡æ³•ç«™ç«‹</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-xs text-gray-500 block mb-1">æŠ½æ/ç¥ç¶“</label>
                                <select id="seizures" class="w-full bg-gray-50 border-0 rounded-lg p-2 text-sm">
                                    <option value="none">ç„¡</option>
                                    <option value="twitch">è¼•å¾®æŠ½å‹•</option>
                                    <option value="mild">å±€éƒ¨æŠ½æ</option>
                                    <option value="severe">å…¨èº«æŠ½æ</option>
                                </select>
                            </div>
                        </div>

                        <!-- Eyes - Changed to Select -->
                        <div>
                            <label class="text-xs text-gray-500 block mb-1">çœ¼ç›ç‹€æ³ (ä¹¾æ€§FIPé‡é»)</label>
                            <select id="eyes" class="w-full bg-gray-50 border-0 rounded-lg p-2 text-sm">
                                <option value="æ­£å¸¸">æ­£å¸¸</option>
                                <option value="æ··æ¿">æ··æ¿ / ç™½éœ§</option>
                                <option value="è®Šè‰²">è®Šè‰² / è‘¡è„è†œç‚</option>
                                <option value="ç³å­”å¤§å°ä¸ä¸€">ç³å­”å¤§å°ä¸ä¸€ (Anisocoria)</option>
                                <option value="åˆ†æ³Œç‰©">æœ‰åˆ†æ³Œç‰©</option>
                                <option value="ç„¡æ³•å¼µé–‹">ç„¡æ³•å¼µé–‹ / ç•å…‰</option>
                                <option value="å…¶ä»–">å…¶ä»– (è«‹å‚™è¨»)</option>
                            </select>
                        </div>

                        <div>
                            <label class="text-xs text-gray-500 block mb-1">å‚™è¨» (å¤§å°ä¾¿/å‘¼å¸é »ç‡ç­‰)</label>
                            <textarea id="notes" rows="2" class="w-full bg-gray-50 border-0 rounded-lg p-2 text-sm" placeholder="ä¾‹å¦‚ï¼šå‘¼å¸å¹³ç©© (30æ¬¡/åˆ†)ï¼Œä¾¿ä¾¿æˆå½¢..."></textarea>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="sticky bottom-0 bg-white pt-4 pb-8 border-t flex gap-3">
                    <button type="button" onclick="closeModal()" class="flex-1 py-3 rounded-xl border border-gray-300 text-gray-500 font-bold">å–æ¶ˆ</button>
                    <button type="submit" class="flex-1 py-3 rounded-xl bg-brand-primary text-white font-bold shadow-lg">å„²å­˜ç´€éŒ„</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // --- Configuration & Constants ---
        const STORAGE_KEY = 'shirley_fip_data_v1';
        const BIRTH_DATE = new Date('2025-01-25');
        const DIAGNOSIS_DATE = new Date('2025-12-02');
        
        let records = [];

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            loadRecords();
            updateHeaderInfo();
            renderRecords();
            setDefaultDateTime();
        });

        // --- Core Logic ---

        function loadRecords() {
            const data = localStorage.getItem(STORAGE_KEY);
            records = data ? JSON.parse(data) : [];
        }

        function saveRecord(e) {
            e.preventDefault();
            
            const formData = {
                id: document.getElementById('record-id').value || Date.now().toString(),
                date: document.getElementById('date').value,
                time: document.getElementById('time').value,
                weight: parseFloat(document.getElementById('weight').value),
                
                temperature: document.getElementById('temperature').value,
                temp_normal_feel: document.getElementById('temp_normal_feel').checked, // New field
                
                food_wet: document.getElementById('food_wet').value,
                food_dry: document.getElementById('food_dry').value,
                food_treats: document.getElementById('food_treats').value,
                food_sos: document.getElementById('food_sos').value, // New field: Emergency food
                
                meds_fip_time: document.getElementById('meds_fip_time').value,
                meds_fip_amount: document.getElementById('meds_fip_amount').value,
                meds_anemia: document.getElementById('meds_anemia').checked,
                meds_immune: document.getElementById('meds_immune').checked,
                appetite_ear: document.querySelector('input[name="appetite_ear"]:checked').value,
                
                mood: document.getElementById('mood').value,
                mobility: document.getElementById('mobility').value,
                seizures: document.getElementById('seizures').value,
                eyes: document.getElementById('eyes').value, // Now a select value
                notes: document.getElementById('notes').value,
                timestamp: new Date().toISOString()
            };

            // Check if editing existing
            const index = records.findIndex(r => r.id === formData.id);
            if (index > -1) {
                records[index] = formData;
            } else {
                records.push(formData);
            }

            // Sort by Date Descending (Newest first) + Time Descending
            records.sort((a, b) => {
                const dateA = new Date(a.date + 'T' + a.time);
                const dateB = new Date(b.date + 'T' + b.time);
                return dateB - dateA;
            });

            localStorage.setItem(STORAGE_KEY, JSON.stringify(records));
            
            closeModal();
            renderRecords();
            updateHeaderInfo();
            
            // alert('ç´€éŒ„å·²å„²å­˜ï¼Shirley åŠ æ²¹ï¼');
        }

        function deleteRecord(id) {
            if(confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†ç´€éŒ„å—ï¼Ÿ')) {
                records = records.filter(r => r.id !== id);
                localStorage.setItem(STORAGE_KEY, JSON.stringify(records));
                renderRecords();
                updateHeaderInfo();
            }
        }

        function editRecord(id) {
            const rec = records.find(r => r.id === id);
            if (!rec) return;

            document.getElementById('record-id').value = rec.id;
            document.getElementById('date').value = rec.date;
            document.getElementById('time').value = rec.time;
            document.getElementById('weight').value = rec.weight;
            
            // Temp logic
            document.getElementById('temperature').value = rec.temperature || '';
            const isNormalFeel = rec.temp_normal_feel || false; // Backward compatibility
            document.getElementById('temp_normal_feel').checked = isNormalFeel;
            toggleTemperatureInput(document.getElementById('temp_normal_feel')); // Trigger UI state

            document.getElementById('food_wet').value = rec.food_wet;
            document.getElementById('food_dry').value = rec.food_dry;
            document.getElementById('food_treats').value = rec.food_treats;
            document.getElementById('food_sos').value = rec.food_sos || ''; // Handle old records
            
            document.getElementById('meds_fip_time').value = rec.meds_fip_time;
            document.getElementById('meds_fip_amount').value = rec.meds_fip_amount;
            document.getElementById('meds_anemia').checked = rec.meds_anemia;
            document.getElementById('meds_immune').checked = rec.meds_immune;
            
            // Radio button handling
            const earVal = rec.appetite_ear || 'none';
            const radio = document.querySelector(`input[name="appetite_ear"][value="${earVal}"]`);
            if (radio) radio.checked = true;
            
            document.getElementById('mood').value = rec.mood;
            document.getElementById('val-mood').innerText = rec.mood;
            document.getElementById('mobility').value = rec.mobility;
            document.getElementById('seizures').value = rec.seizures;
            document.getElementById('eyes').value = rec.eyes || 'æ­£å¸¸'; // Default to normal if missing
            document.getElementById('notes').value = rec.notes;

            document.getElementById('modal-title').innerText = 'âœï¸ ç·¨è¼¯ç´€éŒ„';
            openModal();
        }

        // --- Logic for Temperature Checkbox ---
        function toggleTemperatureInput(checkbox) {
            const tempInput = document.getElementById('temperature');
            if (checkbox.checked) {
                tempInput.value = '38.5';
                tempInput.disabled = true;
            } else {
                tempInput.disabled = false;
                if(tempInput.value == '38.5') tempInput.value = ''; // clear if it was auto-set
            }
        }

        // --- UI Rendering ---

        function renderRecords() {
            const container = document.getElementById('records-container');
            container.innerHTML = '';

            if (records.length === 0) {
                container.innerHTML = `<div class="text-center py-10 text-gray-400"><i class="fas fa-paw text-4xl mb-2 opacity-50"></i><p>ç›®å‰é‚„æ²’æœ‰ç´€éŒ„</p></div>`;
                return;
            }

            records.forEach((rec, index) => {
                // Calculate Weight Delta
                // Find the next chronologically older record (which is index + 1 since array is sorted Desc)
                let weightDiffHtml = '';
                const prevRec = records[index + 1];
                
                if (prevRec && prevRec.weight) {
                    const diff = rec.weight - prevRec.weight;
                    if (diff > 0) {
                        weightDiffHtml = `<span class="text-state-good text-xs font-bold bg-green-50 px-1 rounded"><i class="fas fa-arrow-up"></i> ${diff.toFixed(2)}</span>`;
                    } else if (diff < 0) {
                        weightDiffHtml = `<span class="text-state-bad text-xs font-bold bg-red-50 px-1 rounded"><i class="fas fa-arrow-down"></i> ${Math.abs(diff).toFixed(2)}</span>`;
                    } else {
                        weightDiffHtml = `<span class="text-gray-400 text-xs">-</span>`;
                    }
                }

                // Status badges
                const moodStars = 'â­'.repeat(rec.mood);
                
                // Ear meds badge
                let earBadge = '';
                if (rec.appetite_ear === 'left') earBadge = '<span class="px-2 py-0.5 bg-blue-100 text-blue-700 rounded text-xs">å·¦è€³è—¥</span>';
                if (rec.appetite_ear === 'right') earBadge = '<span class="px-2 py-0.5 bg-blue-100 text-blue-700 rounded text-xs">å³è€³è—¥</span>';

                // FIP Meds Status (More prominent)
                const fipMedStatus = rec.meds_fip_amount 
                    ? `<div class="flex items-center gap-1 bg-brand-primary/10 px-2 py-1 rounded-lg">
                         <span class="text-xs text-brand-primary font-bold">GSæ‰“é‡</span>
                         <span class="text-lg font-bold text-brand-primary">${rec.meds_fip_amount}ml</span>
                       </div>` 
                    : '<span class="text-xs text-gray-300 border border-dashed border-gray-300 px-2 py-1 rounded">æœªæ‰“</span>';

                // Food display strings
                const fWet = rec.food_wet ? `<span class="text-gray-600">æ¿•${rec.food_wet}g</span>` : '';
                const fDry = rec.food_dry ? `<span class="text-gray-600">ä¹¾${rec.food_dry}g</span>` : '';
                const fTreats = rec.food_treats ? `<span class="text-yellow-600">é›¶${rec.food_treats}g</span>` : '';
                const fSos = rec.food_sos ? `<span class="text-red-500 font-bold">æ€¥${rec.food_sos}g</span>` : '';
                
                // Join non-empty food strings
                const foodDisplay = [fWet, fDry, fTreats, fSos].filter(Boolean).join(' / ') || '<span class="text-gray-300">ç„¡é£²é£Ÿç´€éŒ„</span>';

                // Temp Display
                const tempDisplay = rec.temp_normal_feel 
                    ? `<span class="text-state-good font-bold"><i class="fas fa-check-circle"></i> 38.5Â°C (æ­£å¸¸)</span>`
                    : (rec.temperature ? `${rec.temperature}Â°C` : '--');

                const card = document.createElement('div');
                card.className = 'bg-white rounded-2xl p-4 card-shadow relative overflow-hidden border-l-4 border-transparent hover:border-brand-primary transition-all';
                card.innerHTML = `
                    <!-- Header Row -->
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <div class="flex items-baseline gap-2">
                                <span class="text-lg font-bold text-gray-700">${rec.date.slice(5)}</span>
                                <span class="text-xs text-gray-400 bg-gray-100 px-1.5 py-0.5 rounded">${rec.time}</span>
                            </div>
                            <div class="flex items-center gap-2 mt-1">
                                <span class="text-xl font-bold text-gray-800">${rec.weight} kg</span>
                                ${weightDiffHtml}
                            </div>
                        </div>
                        <div class="flex flex-col items-end gap-1">
                            ${fipMedStatus}
                            <div class="text-[10px] text-gray-400 mt-1">${moodStars}</div>
                        </div>
                    </div>

                    <!-- Details Grid -->
                    <div class="grid grid-cols-1 gap-2 text-xs bg-gray-50 p-3 rounded-xl mb-2">
                        <div class="flex items-center gap-2">
                            <i class="fas fa-utensils text-gray-400 w-4"></i>
                            <div>${foodDisplay}</div>
                        </div>
                        <div class="flex items-center gap-2">
                            <i class="fas fa-thermometer-half text-gray-400 w-4"></i>
                            <div>${tempDisplay}</div>
                        </div>
                        
                        <!-- Pills Row -->
                        ${ (rec.meds_anemia || rec.meds_immune || earBadge) 
                           ? `<div class="flex flex-wrap gap-1 mt-1 border-t border-gray-200 pt-2">
                                ${rec.meds_anemia ? '<span class="px-1.5 bg-red-100 text-red-600 rounded">è£œè¡€è—¥</span>' : ''}
                                ${rec.meds_immune ? '<span class="px-1.5 bg-green-100 text-green-600 rounded">å…ç–«è—¥</span>' : ''}
                                ${earBadge}
                              </div>`
                           : ''
                        }
                    </div>

                    <!-- Serious Symptoms Check -->
                    ${ (rec.mobility !== 'normal' || rec.seizures !== 'none' || (rec.eyes && rec.eyes !== 'æ­£å¸¸')) 
                        ? `<div class="bg-red-50 text-red-700 px-3 py-2 rounded-lg text-xs mb-2 border border-red-100 flex flex-wrap gap-2">
                             ${rec.mobility !== 'normal' ? `<span class="font-bold">âš ï¸ ${translateOption(rec.mobility)}</span>` : ''}
                             ${rec.seizures !== 'none' ? `<span class="font-bold">âš¡ ${translateOption(rec.seizures)}</span>` : ''}
                             ${(rec.eyes && rec.eyes !== 'æ­£å¸¸') ? `<span class="font-bold">ğŸ‘ï¸ çœ¼: ${rec.eyes}</span>` : ''}
                           </div>` 
                        : '' 
                    }

                    ${rec.notes ? `<p class="text-sm text-gray-600 border-l-2 border-brand-accent pl-2 italic my-2">"${rec.notes}"</p>` : ''}

                    <!-- Actions -->
                    <div class="absolute bottom-4 right-4 flex gap-4 opacity-30 hover:opacity-100 transition-opacity">
                        <button onclick="editRecord('${rec.id}')" class="text-blue-500 hover:text-blue-700"><i class="fas fa-edit text-lg"></i></button>
                        <button onclick="deleteRecord('${rec.id}')" class="text-red-500 hover:text-red-700"><i class="fas fa-trash text-lg"></i></button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function updateHeaderInfo() {
            // Age Calc
            const now = new Date();
            const ageInMonths = (now.getFullYear() - BIRTH_DATE.getFullYear()) * 12 + (now.getMonth() - BIRTH_DATE.getMonth());
            document.getElementById('age-display').innerText = `${ageInMonths} å€‹æœˆå¤§`;

            // Treatment Days
            const diffTime = Math.abs(now - DIAGNOSIS_DATE);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
            document.getElementById('day-counter').innerText = `Day ${diffDays}`;

            // Latest Weight
            if (records.length > 0) {
                document.getElementById('latest-weight').innerText = `${records[0].weight} kg`;
                
                // Check if meds done today (using naive date string check)
                const todayStr = new Date().toISOString().split('T')[0];
                const todayRec = records.find(r => r.date === todayStr);
                
                if (todayRec && todayRec.meds_fip_amount && todayRec.meds_fip_amount > 0) {
                    document.getElementById('today-med-status').innerText = 'å·²å®Œæˆ âœ…';
                    document.getElementById('today-med-status').className = 'font-bold text-state-good text-lg';
                } else {
                    document.getElementById('today-med-status').innerText = 'æœªå®Œæˆ';
                    document.getElementById('today-med-status').className = 'font-bold text-state-bad text-lg';
                }
            }
        }

        // --- Utilities ---

        function openModal() {
            document.getElementById('entry-modal').classList.remove('hidden');
            // Reset form if opening fresh (not edit)
            if(document.getElementById('modal-title').innerText.includes('ç·¨è¼¯')) {
                // Keep data
            } else {
                document.getElementById('care-form').reset();
                document.getElementById('record-id').value = '';
                // Reset checkbox state
                document.getElementById('temp_normal_feel').checked = false;
                toggleTemperatureInput(document.getElementById('temp_normal_feel'));
                
                setDefaultDateTime();
                document.getElementById('modal-title').innerText = 'ğŸ“ è¨˜éŒ„ Shirley çš„ç‹€æ³';
                // Pre-fill last weight for convenience
                if(records.length > 0) {
                    document.getElementById('weight').value = records[0].weight;
                }
            }
        }

        function closeModal() {
            document.getElementById('entry-modal').classList.add('hidden');
            // Small timeout to reset title after animation visually
            setTimeout(() => {
                document.getElementById('modal-title').innerText = 'ğŸ“ è¨˜éŒ„ Shirley çš„ç‹€æ³';
                document.getElementById('care-form').reset();
                document.getElementById('record-id').value = '';
            }, 300);
        }

        function setDefaultDateTime() {
            const now = new Date();
            // Handle timezone offset for local string
            const offset = now.getTimezoneOffset() * 60000;
            const localISOTime = (new Date(now - offset)).toISOString().slice(0, -1);
            
            document.getElementById('date').value = localISOTime.split('T')[0];
            document.getElementById('time').value = now.toTimeString().slice(0,5);
        }

        function translateOption(val) {
            const dict = {
                'normal': 'è¡Œå‹•æ­£å¸¸', 'slow': 'è¡Œå‹•ç·©æ…¢', 'wobbly': 'è…³æ­¥ä¸ç©©', 'dragging': 'æ‹–è¡Œ',
                'none': 'ç„¡æŠ½æ', 'twitch': 'è¼•å¾®æŠ½å‹•', 'mild': 'å±€éƒ¨æŠ½æ', 'severe': 'åš´é‡æŠ½æ'
            };
            return dict[val] || val;
        }

        function exportData() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(records));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "shirley_fip_data.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

    </script>
</body>
</html>
