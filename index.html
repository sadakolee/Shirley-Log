<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shirley FIP ä¹¾æ€§è…¹è†œç‚è¿½è¹¤ç´€éŒ„ (æœ¬æ©Ÿç‰ˆ)</title>
    <!-- Tailwind CSS CDN for modern, responsive styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f9;
        }
        /* Custom scrollbar for better look */
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-thumb {
            background-color: #a8a8a8;
            border-radius: 3px;
        }
        .custom-scroll::-webkit-scrollbar-track {
            background-color: #f0f0f0;
        }
        /* General input styling */
        input[type="number"], input[type="text"], input[type="date"], input[type="time"], select, textarea {
            border: 1px solid #e2e8f0;
            padding: 10px;
            border-radius: 8px;
            width: 100%;
            transition: all 0.2s;
        }
        input:focus, select:focus, textarea:focus {
            border-color: #10b981; /* ç¶ è‰²ï¼Œä»£è¡¨æœ¬æ©Ÿé€£ç·šæˆåŠŸ */
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2);
            outline: none;
        }
        /* New styling for medication checkboxes */
        input[type="checkbox"] {
            transform: scale(1.2);
            cursor: pointer;
        }
        /* Styling for the notes column to allow wrapping */
        .notes-cell {
            white-space: normal;
            word-break: break-all;
            max-width: 150px; /* Limit width for table readability */
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <!-- Main Application Container -->
    <div class="max-w-5xl mx-auto bg-white shadow-xl rounded-xl p-6 md:p-10">

        <h1 class="text-3xl md:text-4xl font-extrabold text-green-700 mb-2">
            Shirley ç·¬å› è²“ FIP è¿½è¹¤ (æœ¬æ©Ÿç‰ˆ)
        </h1>
        <p class="text-gray-600 mb-6">
            <span class="font-semibold text-pink-600">Shirley (2025å¹´1æœˆåº•ç”Ÿ)</span> ä¹¾æ€§FIPç´€éŒ„ - è¿½è¹¤æ—¥æœŸï¼š<span id="current-date"></span>
        </p>
        
        <!-- Navigation Tabs -->
        <div class="flex border-b border-gray-200 mb-6">
            <button id="tab-tracker" onclick="showView('tracker')" class="px-4 py-2 text-sm font-medium border-b-2 border-green-500 text-green-600 focus:outline-none">
                æ¯æ—¥ç´€éŒ„
            </button>
            <button id="tab-summary" onclick="showView('summary')" class="px-4 py-2 text-sm font-medium text-gray-500 hover:text-green-600 hover:border-green-500 focus:outline-none">
                æ­·å²ç¸½çµ
            </button>
            <button id="tab-report" onclick="showView('report')" class="px-4 py-2 text-sm font-medium text-gray-500 hover:text-green-600 hover:border-green-500 focus:outline-none">
                å ±å‘Š/åœ–ç‰‡å„²å­˜ (æœ¬æ©Ÿ)
            </button>
        </div>

        <!-- LOCAL STORAGE STATUS MESSAGE -->
        <div id="auth-status" class="bg-green-100 border-l-4 border-green-500 text-green-700 p-4 mb-4 rounded-lg" role="alert">
            <p class="font-bold">æœ¬åœ°å„²å­˜å•Ÿç”¨ï¼</p>
            <p>ç´€éŒ„åƒ…å„²å­˜åœ¨æ‚¨çš„ç€è¦½å™¨ä¸­ã€‚è«‹æ³¨æ„å‚™ä»½ã€‚</p>
        </div>

        <!-- 1. DAILY TRACKER VIEW -->
        <div id="tracker-view">
            <form id="record-form" class="grid grid-cols-1 md:grid-cols-2 gap-6 p-4 border rounded-lg shadow-inner bg-green-50">
                
                <div class="md:col-span-2">
                    <label for="recordDate" class="block text-sm font-medium text-gray-700 mb-1">ç´€éŒ„æ—¥æœŸ <span class="text-red-500">*</span></label>
                    <input type="date" id="recordDate" required>
                </div>

                <!-- é£²é£Ÿç‹€æ³ (ç¨®é¡) -->
                <div>
                    <label for="diet" class="block text-sm font-medium text-gray-700 mb-1">é£²é£Ÿç‹€æ³ (ç¨®é¡)</label>
                    <select id="diet" required>
                        <option value="æ¿•ç³§">æ¿•ç³§ (Wet Food)</option>
                        <option value="ä¹¾ç³§">ä¹¾ç³§ (Dry Food)</option>
                        <option value="æ€¥æ•‘ç³§">æ€¥æ•‘ç³§/é¤µé£Ÿ (Critical Care/Syringe)</option>
                        <option value="æ‹’é£Ÿ">å®Œå…¨æ‹’é£Ÿ</option>
                    </select>
                </div>
                
                <!-- é£²é£Ÿä»½é‡ (æ–°å¢) -->
                <div>
                    <label for="dietQuantity" class="block text-sm font-medium text-gray-700 mb-1">é£²é£Ÿä»½é‡ (g/ml/ä»½)</label>
                    <input type="number" id="dietQuantity" step="0.1" min="0" placeholder="ä¾‹å¦‚ï¼š100 (g) æˆ– 5 (ml)">
                </div>

                <!-- é«”é‡ -->
                <div>
                    <label for="weight" class="block text-sm font-medium text-gray-700 mb-1">é«”é‡ (kg) <span class="text-red-500">*</span></label>
                    <input type="number" id="weight" step="0.01" min="0" required placeholder="ä¾‹å¦‚ï¼š4.52">
                </div>

                <!-- ç²¾ç¥ç‹€æ³ -->
                <div>
                    <label for="spirit" class="block text-sm font-medium text-gray-700 mb-1">ç²¾ç¥ç‹€æ³ (FIPé—œéµæŒ‡æ¨™)</label>
                    <select id="spirit" required>
                        <option value="æ¥µå¥½">æ¥µå¥½ (æ´»èºç©è€)</option>
                        <option value="è‰¯å¥½">è‰¯å¥½ (æ­£å¸¸äº’å‹•)</option>
                        <option value="ä¸€èˆ¬">ä¸€èˆ¬ (å®‰éœä¼‘æ¯ç‚ºä¸»)</option>
                        <option value="å·®">å·® (ä¸æ„›å‹•ï¼Œèº²è—)</option>
                        <option value="æ¥µå·®">æ¥µå·® (ç„¡åæ‡‰/è™›å¼±)</option>
                    </select>
                </div>

                <!-- è¡Œå‹• -->
                <div>
                    <label for="movement" class="block text-sm font-medium text-gray-700 mb-1">è¡Œå‹•åŠ›/æ´»èºåº¦</label>
                    <select id="movement" required>
                        <option value="æ´»èº">æ´»èº (è·‘è·³)</option>
                        <option value="æ­£å¸¸">æ­£å¸¸ (ç·©æ…¢èµ°å‹•)</option>
                        <option value="é²ç·©">é²ç·© (ç§»å‹•ç·©æ…¢)</option>
                        <option value="ä¸å‹•">å¹¾ä¹ä¸å‹•</option>
                    </select>
                </div>

                <!-- ç™¼ç‡’èˆ‡å¦ (ä¸»æŒ‡æ¨™) -->
                <div class="flex items-center space-x-4">
                    <label for="hasFever" class="block text-sm font-medium text-gray-700 mb-1">ç™¼ç‡’ç‹€æ…‹ (é«”æº« > 39.2Â°C)</label>
                    <input type="checkbox" id="hasFever" class="h-5 w-5 text-red-600 border-gray-300 rounded focus:ring-red-500">
                    <span id="fever-status" class="text-sm font-semibold">å¦ (No)</span>
                </div>
                
                <!-- è—¥ç‰© ml & æ™‚é–“ -->
                <div>
                    <label for="medicationMl" class="block text-sm font-medium text-gray-700 mb-1">ä¸»è—¥ç‰©åŠ‘é‡ (ml) <span class="text-gray-400">(å¦‚GS-441524)</span></label>
                    <input type="number" id="medicationMl" step="0.01" min="0" placeholder="ä¾‹å¦‚ï¼š2.0">
                </div>
                <div>
                    <label for="medicationTime" class="block text-sm font-medium text-gray-700 mb-1">ä¸»è—¥ç‰©æ™‚é–“</label>
                    <input type="time" id="medicationTime">
                </div>

                <!-- æ–°å¢ï¼šè²§è¡€è—¥ -->
                <div class="flex items-center space-x-4">
                    <label for="medAnemia" class="block text-sm font-medium text-gray-700 mb-1">è²§è¡€è—¥ (Anemia Med)</label>
                    <input type="checkbox" id="medAnemia" class="h-5 w-5 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                </div>

                <!-- æ–°å¢ï¼šå…ç–«åŠ›è—¥ -->
                <div class="flex items-center space-x-4">
                    <label for="medImmunity" class="block text-sm font-medium text-gray-700 mb-1">å…ç–«åŠ›è—¥ (Immunity Booster)</label>
                    <input type="checkbox" id="medImmunity" class="h-5 w-5 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                </div>
                
                <!-- æ–°å¢ï¼šé–‹èƒƒè—¥ (ä½ç½®) -->
                <div>
                    <label for="medAppetite" class="block text-sm font-medium text-gray-700 mb-1">é–‹èƒƒè—¥ (å¡—æŠ¹ä½ç½®)</label>
                    <select id="medAppetite" required>
                        <option value="ç„¡">ç„¡ (Not Given)</option>
                        <option value="å·¦è€³">å·¦è€³ (Left Ear)</option>
                        <option value="å³è€³">å³è€³ (Right Ear)</option>
                    </select>
                </div>

                <!-- å…¶ä»–å‚™è¨» -->
                <div class="md:col-span-2">
                    <label for="notes" class="block text-sm font-medium text-gray-700 mb-1">å…¶ä»–å¿…é ˆçš„é …ç›®èˆ‡å‚™è¨»</label>
                    <textarea id="notes" rows="3" placeholder="ä¾‹å¦‚ï¼šä»Šæ—¥é£²æ°´ä»½é‡ï¼Œæ’æ³„ç‹€æ³ï¼Œè…¹åœæ¸¬é‡..."></textarea>
                </div>

                <!-- Submit Button -->
                <div class="md:col-span-2">
                    <button type="submit" id="saveButton" class="w-full py-3 px-4 bg-green-600 text-white font-bold rounded-lg transition duration-150 shadow-md hover:bg-green-700">
                        ğŸ’¾ å„²å­˜ä»Šæ—¥ç´€éŒ„ (æœ¬æ©Ÿ)
                    </button>
                    <div id="saveMessage" class="mt-3 text-center text-sm font-medium text-green-600 hidden">ç´€éŒ„å·²æˆåŠŸå„²å­˜ï¼</div>
                </div>
            </form>
        </div>

        <!-- 2. SUMMARY/HISTORY VIEW (Updated to include new fields) -->
        <div id="summary-view" class="hidden">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">æ­·å²æ•¸æ“šç¸½çµ (æœ¬æ©Ÿå„²å­˜)</h2>
            <div class="overflow-x-auto custom-scroll max-h-[60vh]">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50 sticky top-0 z-10">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ—¥æœŸ</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">é«”é‡ (kg)</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">è®ŠåŒ–</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">é£²é£Ÿ/ç²¾ç¥</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ç™¼ç‡’/ä¸»è—¥åŠ‘é‡</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">å…¶ä»–è—¥ç‰©</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">å‚™è¨»</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="summaryTableBody" class="bg-white divide-y divide-gray-200">
                        <!-- Data will be injected here -->
                    </tbody>
                </table>
            </div>
             <p class="text-sm text-gray-500 mt-4">
                <span class="text-green-600 font-bold">â–²</span> é«”é‡å¢åŠ  | 
                <span class="text-red-600 font-bold">â–¼</span> é«”é‡æ¸›å°‘ | 
                <span class="text-gray-500 font-bold">=</span> ç„¡è®ŠåŒ–
            </p>
        </div>

        <!-- 3. REPORT/IMAGE STORAGE VIEW -->
        <div id="report-view" class="hidden p-4 border rounded-lg shadow-inner bg-blue-50">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">ğŸ–¼ï¸ å ±å‘Šåœ–ç‰‡/æª”æ¡ˆç®¡ç† (åƒ…æœ¬æ©Ÿ)</h2>
            <p class="text-sm text-gray-600 mb-4">
                æ‚¨å¯ä»¥é¸æ“‡å ±å‘Šåœ–ç‰‡ï¼ˆä¾‹å¦‚ï¼šé©—è¡€å ±å‘Šã€è¶…éŸ³æ³¢åœ–ç­‰ï¼‰æˆ–ä»»ä½•æª”æ¡ˆã€‚
                <span class="font-bold text-red-600">é‡è¦æé†’ï¼šç”±æ–¼æ¡ç”¨ç€è¦½å™¨æœ¬æ©Ÿå„²å­˜ï¼Œæ­¤åŠŸèƒ½ç„¡æ³•çœŸæ­£å°‡æª”æ¡ˆæ°¸ä¹…å„²å­˜æˆ–ä¸Šå‚³ã€‚å®ƒåƒ…ç”¨æ–¼æš«æ™‚æŸ¥çœ‹æª”æ¡ˆè³‡è¨Šã€‚</span>
            </p>

            <input type="file" id="reportFile" class="w-full mb-4 p-2 border rounded-lg bg-white">
            
            <div id="fileInfo" class="mt-6 p-4 bg-white border border-blue-200 rounded-lg shadow-inner min-h-20">
                <p class="text-gray-500 text-center">æª”æ¡ˆè³‡è¨Šå°‡é¡¯ç¤ºåœ¨æ­¤è™•ã€‚</p>
            </div>
        </div>
        
    </div>

    <!-- Custom Alert Modal (for non-confirmation messages) -->
    <div id="temp-alert-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 transition-opacity duration-300 hidden">
        <div class="bg-white rounded-lg shadow-2xl p-6 w-80 m-4">
            <h3 class="text-lg font-bold mb-4 text-gray-800">æç¤º</h3>
            <p id="alert-message" class="text-gray-600 mb-6"></p>
            <div class="flex justify-end">
                <button id="modal-ok" class="py-2 px-4 bg-green-600 text-white rounded-lg hover:bg-green-700 transition">ç¢ºå®š</button>
            </div>
        </div>
    </div>

    <!-- Custom Confirm Modal (for deletion) -->
    <div id="temp-confirm-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 transition-opacity duration-300 hidden">
        <div class="bg-white rounded-lg shadow-2xl p-6 w-80 m-4">
            <h3 class="text-lg font-bold mb-4 text-gray-800">æ“ä½œç¢ºèª</h3>
            <p id="modal-message" class="text-gray-600 mb-6"></p>
            <div class="flex justify-end space-x-3">
                <button id="modal-cancel" class="py-2 px-4 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-100 transition">å–æ¶ˆ</button>
                <button id="modal-confirm" class="py-2 px-4 bg-red-500 text-white rounded-lg hover:bg-red-600 transition">ç¢ºå®š</button>
            </div>
        </div>
    </div>
    
    <!-- Local Storage Scripts -->
    <script>
        
        // Global State & Constants
        const CONSTANTS = {
            LOCAL_STORAGE_KEY: 'shirley_fip_records_local', // å„²å­˜åœ¨ localStorage çš„ key
        };
        
        const DOM = {
            recordForm: document.getElementById('record-form'),
            summaryTableBody: document.getElementById('summaryTableBody'),
            saveButton: document.getElementById('saveButton'),
            saveMessage: document.getElementById('saveMessage'),
            authStatus: document.getElementById('auth-status'),
            reportFile: document.getElementById('reportFile'), // Kept for image storage feature
            fileInfo: document.getElementById('fileInfo'), // New DOM element for file info
            feverStatus: document.getElementById('fever-status'),
            hasFever: document.getElementById('hasFever'),
        };

        let localRecords = []; // å„²å­˜åœ¨è¨˜æ†¶é«”ä¸­çš„æ¯æ—¥ç´€éŒ„

        // --- Utility Functions for Modals ---

        /**
         * Custom alert for non-blocking messages (replaces window.alert)
         * @param {string} message - Message to display
         */
        function customAlert(message) {
             const modal = document.getElementById('temp-alert-modal');
             if (!modal) return;
             
             document.getElementById('alert-message').textContent = message;
             modal.classList.remove('hidden');
             
             document.getElementById('modal-ok').onclick = () => {
                 modal.classList.add('hidden');
             };
        }

        /**
         * Custom confirm function for deletion (replaces window.confirm)
         * @param {string} message - Message to display
         * @returns {Promise<boolean>}
         */
         function customConfirmDelete(message) {
            return new Promise((resolve) => {
                const modal = document.getElementById('temp-confirm-modal');
                if (!modal) return resolve(false);

                document.getElementById('modal-message').textContent = message;
                modal.classList.remove('hidden');
                
                document.getElementById('modal-cancel').onclick = () => {
                    modal.classList.add('hidden');
                    resolve(false);
                };
                
                document.getElementById('modal-confirm').onclick = () => {
                    modal.classList.add('hidden');
                    resolve(true);
                };
            });
        }


        // --- Local Storage Functions ---

        /**
         * å¾ localStorage è¼‰å…¥ç´€éŒ„åˆ° memory
         */
        function loadRecords() {
            try {
                const json = localStorage.getItem(CONSTANTS.LOCAL_STORAGE_KEY);
                localRecords = json ? JSON.parse(json) : [];
                // ç¢ºä¿æ•¸æ“šæ˜¯ä¾ç…§æ—¥æœŸé™å†ªæ’åº (æ–°åˆ°èˆŠ)
                localRecords.sort((a, b) => new Date(b.date) - new Date(a.date));
                renderRecords(localRecords);
            } catch (e) {
                console.error("Error loading records from localStorage:", e);
                customAlert('è¼‰å…¥èˆŠç´€éŒ„å¤±æ•—ï¼Œå¯èƒ½æ˜¯å„²å­˜è³‡æ–™æå£ã€‚å°‡é‡æ–°é–‹å§‹ç´€éŒ„ã€‚');
                localRecords = [];
                renderRecords([]);
            }
        }

        /**
         * å°‡è¨˜æ†¶é«”ä¸­çš„ç´€éŒ„å­˜å› localStorage
         */
        function saveLocalRecords() {
            try {
                localStorage.setItem(CONSTANTS.LOCAL_STORAGE_KEY, JSON.stringify(localRecords));
            } catch (e) {
                console.error("Error saving records to localStorage:", e);
                customAlert('å„²å­˜ç´€éŒ„å¤±æ•—ï¼Œå¯èƒ½æ˜¯æ‚¨çš„ç€è¦½å™¨ç©ºé–“ä¸è¶³ã€‚');
            }
        }

        /**
         * å„²å­˜æ¯æ—¥ç´€éŒ„åˆ° localStorage
         */
        function saveRecord(event) {
            event.preventDefault();
            
            const recordDate = document.getElementById('recordDate').value;
            const weightInput = document.getElementById('weight');
            const weight = parseFloat(weightInput.value);
            
            // è™•ç†é£²é£Ÿä»½é‡ï¼Œå¦‚æœä¸æ˜¯æ•¸å­—å°±ç•¶ä½œ 0
            const dietQuantity = parseFloat(document.getElementById('dietQuantity').value) || 0;
            
            if (!recordDate || isNaN(weight) || weight <= 0) {
                customAlert('è«‹è¼¸å…¥æœ‰æ•ˆçš„æ—¥æœŸå’Œé«”é‡ï¼ˆå¿…é ˆå¤§æ–¼ 0 kgï¼‰ã€‚');
                weightInput.focus();
                return;
            }

            const newRecord = {
                // ä½¿ç”¨ date ä½œç‚ºç´€éŒ„çš„å”¯ä¸€è­˜åˆ¥ç¬¦
                id: recordDate, 
                date: recordDate, 
                diet: document.getElementById('diet').value,
                dietQuantity: dietQuantity, // å„²å­˜é£²é£Ÿä»½é‡
                weight: weight,
                spirit: document.getElementById('spirit').value,
                movement: document.getElementById('movement').value,
                hasFever: DOM.hasFever.checked,
                
                // è—¥ç‰©è¿½è¹¤é …ç›®
                medAnemia: document.getElementById('medAnemia').checked,
                medImmunity: document.getElementById('medImmunity').checked,
                medAppetite: document.getElementById('medAppetite').value, // å„²å­˜ 'ç„¡', 'å·¦è€³', or 'å³è€³'

                medicationMl: parseFloat(document.getElementById('medicationMl').value) || 0,
                medicationTime: document.getElementById('medicationTime').value || '',
                notes: document.getElementById('notes').value.trim() || 'ç„¡',
                lastUpdated: new Date().toISOString()
            };

            // æª¢æŸ¥æ˜¯å¦ç‚ºæ›´æ–°ç¾æœ‰ç´€éŒ„
            const existingIndex = localRecords.findIndex(r => r.date === recordDate);

            if (existingIndex !== -1) {
                // æ›´æ–°ç¾æœ‰ç´€éŒ„
                localRecords[existingIndex] = newRecord;
                console.log(`Updated record for ${recordDate}`);
            } else {
                // æ–°å¢ç´€éŒ„
                localRecords.push(newRecord);
                console.log(`Added new record for ${recordDate}`);
            }

            // é‡æ–°æ’åºä¸¦å„²å­˜
            localRecords.sort((a, b) => new Date(b.date) - new Date(a.date));
            saveLocalRecords();
            renderRecords(localRecords);
            
            DOM.saveMessage.classList.remove('hidden');
            
            // æ¸…ç©ºéƒ¨åˆ†è¼¸å…¥æ¬„ä½ï¼Œæ–¹ä¾¿è¼¸å…¥ä¸‹ä¸€æ¬¡ç´€éŒ„
            document.getElementById('weight').value = '';
            document.getElementById('medicationMl').value = '';
            document.getElementById('dietQuantity').value = ''; // æ¸…ç©ºä»½é‡
            document.getElementById('notes').value = '';

            setTimeout(() => DOM.saveMessage.classList.add('hidden'), 3000);
        }

        /**
         * åˆªé™¤ç‰¹å®šæ—¥æœŸçš„ç´€éŒ„
         * @param {string} date - ç´€éŒ„çš„æ—¥æœŸ (ä½œç‚ºDocument ID)
         */
        async function deleteRecord(date) {
            
            const confirmDelete = await customConfirmDelete(`ç¢ºå®šè¦åˆªé™¤ ${date} çš„ç´€éŒ„å—ï¼Ÿ`);
            if (!confirmDelete) return;

            // éæ¿¾æ‰è¦åˆªé™¤çš„ç´€éŒ„
            localRecords = localRecords.filter(r => r.date !== date);
            
            saveLocalRecords();
            renderRecords(localRecords);
            console.log(`Deleted record for ${date}`);
        }

        // --- UI Rendering ---
        
        /**
         * æ¸²æŸ“æ­·å²ç´€éŒ„è¡¨æ ¼
         * @param {Array<Object>} records - å·²æ’åº (æ–°åˆ°èˆŠ) çš„æ¯æ—¥ç´€éŒ„
         */
        function renderRecords(records) {
            if (records.length === 0) {
                DOM.summaryTableBody.innerHTML = '<tr><td colspan="8" class="p-6 text-center text-gray-500">å°šç„¡ç´€éŒ„ã€‚è«‹å‰å¾€ã€Œæ¯æ—¥ç´€éŒ„ã€è¼¸å…¥æ•¸æ“šã€‚</td></tr>';
                return;
            }

            let html = '';
            // ç”±æ–¼ records å·²æ˜¯æ–°åˆ°èˆŠæ’åºï¼Œæˆ‘å€‘éœ€è¦åå‘è¿­ä»£ä¾†è¨ˆç®—ã€Œå‰ä¸€å¤©ã€çš„æ•¸å€¼ï¼Œç„¶å¾Œå†ä»¥æ–°åˆ°èˆŠçš„é †åºæ¸²æŸ“
            const sortedByOldest = [...records].reverse();
            const newestRecordsWithChange = []; 

            for (let i = 0; i < sortedByOldest.length; i++) {
                const current = sortedByOldest[i];
                let weightChange = 0;
                let changeColor = 'text-gray-500';
                let changeIcon = '=';

                // æ‰¾åˆ°å‰ä¸€å¤©çš„æœ‰æ•ˆé«”é‡ (å‰ä¸€å€‹å…ƒç´ )
                if (i > 0) {
                    const previous = sortedByOldest[i - 1];
                    // è¨ˆç®—é«”é‡è®ŠåŒ–
                    weightChange = current.weight - previous.weight;
                    
                    if (weightChange > 0.01) { 
                        changeColor = 'text-green-600 font-bold';
                        changeIcon = 'â–²';
                    } else if (weightChange < -0.01) { 
                        changeColor = 'text-red-600 font-bold';
                        changeIcon = 'â–¼';
                    }
                }
                
                // å°‡è¨ˆç®—çµæœå„²å­˜èµ·ä¾†
                const recordWithChange = {
                    ...current,
                    weightChange: weightChange.toFixed(2),
                    changeColor: changeColor,
                    changeIcon: changeIcon
                };
                newestRecordsWithChange.unshift(recordWithChange); // æ”¾å›æ–°åˆ°èˆŠçš„é †åº
            }
            
            // æ¸²æŸ“è¡¨æ ¼
            html = newestRecordsWithChange.map(record => {
                // æ ¼å¼åŒ–é£²é£Ÿç‹€æ³ (åŒ…å«ä»½é‡)
                const dietDisplay = `${record.diet}` + 
                                    (record.dietQuantity > 0 ? `<br><span class="text-xs text-gray-400">(${record.dietQuantity} é‡)</span>` : '');

                return `
                <tr class="${record.hasFever ? 'bg-red-50/70 hover:bg-red-100/70' : 'hover:bg-gray-50'} transition duration-100">
                    <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${record.date}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm">${record.weight.toFixed(2)} kg</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm ${record.changeColor}">
                        ${record.changeIcon} ${record.changeIcon !== '=' ? Math.abs(parseFloat(record.weightChange)).toFixed(2) : '0.00'}
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-600">
                        ${dietDisplay} / ${record.spirit}
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-600">
                        ${record.hasFever ? '<span class="text-red-500 font-bold">ç™¼ç‡’ Yes</span>' : 'ç„¡ç™¼ç‡’ No'}<br>
                        ${record.medicationMl > 0 ? `${record.medicationMl.toFixed(2)} ml @ ${record.medicationTime}` : 'ç„¡ä¸»è—¥'}
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-600">
                        ${record.medAnemia ? 'è²§è¡€è—¥ <span class="text-indigo-600">âœ”ï¸</span><br>' : ''}
                        ${record.medImmunity ? 'å…ç–«åŠ›è—¥ <span class="text-indigo-600">âœ”ï¸</span><br>' : ''}
                        ${record.medAppetite !== 'ç„¡' ? `é–‹èƒƒè—¥ (${record.medAppetite})` : 'ç„¡é–‹èƒƒè—¥'}
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-600 notes-cell">${record.notes}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm">
                        <button onclick="deleteRecord('${record.date}')" class="text-red-500 hover:text-red-700 font-medium text-xs rounded-full p-1 transition duration-150">
                            ğŸ—‘ï¸ åˆªé™¤
                        </button>
                    </td>
                </tr>
            `}).join('');

            DOM.summaryTableBody.innerHTML = html;
        }

        /**
         * é¡¯ç¤ºæŒ‡å®šçš„è¦–åœ–ä¸¦æ›´æ–°Tabæ¨£å¼
         * @param {string} viewId - è¦é¡¯ç¤ºçš„è¦–åœ–ID ('tracker', 'summary', 'report')
         */
        window.showView = function(viewId) {
            ['tracker', 'summary', 'report'].forEach(id => { 
                const view = document.getElementById(`${id}-view`);
                const tab = document.getElementById(`tab-${id}`);
                if (view) view.classList.add('hidden');
                if (tab) {
                    tab.classList.remove('border-green-500', 'text-green-600');
                    tab.classList.add('text-gray-500', 'hover:text-green-600', 'hover:border-green-500');
                }
            });

            const activeView = document.getElementById(`${viewId}-view`);
            const activeTab = document.getElementById(`tab-${viewId}`);
            
            if (activeView) activeView.classList.remove('hidden');
            if (activeTab) {
                activeTab.classList.add('border-green-500', 'text-green-600');
                activeTab.classList.remove('text-gray-500', 'hover:text-green-600', 'hover:border-green-500');
            }

            // ç¢ºä¿åˆ‡æ›åˆ° summary æ™‚æ•¸æ“šæ˜¯æœ€æ–°çš„
            if (viewId === 'summary') {
                loadRecords();
            }
        }

        /**
         * ç›£è½ç™¼ç‡’å‹¾é¸æ¡†è®ŠåŒ–ï¼Œæ›´æ–°æ–‡å­—
         */
        DOM.hasFever.addEventListener('change', (e) => {
            if (e.target.checked) {
                DOM.feverStatus.textContent = 'æ˜¯ (Yes)';
                DOM.feverStatus.classList.remove('text-sm', 'font-semibold');
                DOM.feverStatus.classList.add('text-red-500', 'font-bold');
            } else {
                DOM.feverStatus.textContent = 'å¦ (No)';
                DOM.feverStatus.classList.add('text-sm', 'font-semibold');
                DOM.feverStatus.classList.remove('text-red-500', 'font-bold');
            }
        });
        
        // --- Report/Image File Info Handler ---
        document.addEventListener('DOMContentLoaded', () => {
            if (DOM.reportFile) {
                DOM.reportFile.addEventListener('change', () => {
                    const file = DOM.reportFile.files[0];
                    if (file) {
                        DOM.fileInfo.innerHTML = `
                            <p class="font-semibold text-gray-800">âœ… å·²é¸æ“‡æª”æ¡ˆï¼š${file.name}</p>
                            <p class="text-sm text-gray-600">é¡å‹ï¼š${file.type}</p>
                            <p class="text-sm text-gray-600">å¤§å°ï¼š${(file.size / 1024 / 1024).toFixed(2)} MB</p>
                            <p class="text-sm text-red-500 font-medium mt-1">æ³¨æ„ï¼šæ­¤æª”æ¡ˆåƒ…é¡¯ç¤ºè³‡è¨Šï¼Œä¸¦æœªæ°¸ä¹…å„²å­˜åˆ°ç¶²è·¯ä¸Šæˆ–æœ¬æ©Ÿå„²å­˜ç©ºé–“ã€‚</p>
                        `;
                    } else {
                        DOM.fileInfo.innerHTML = `<p class="text-gray-500 text-center">æª”æ¡ˆè³‡è¨Šå°‡é¡¯ç¤ºåœ¨æ­¤è™•ã€‚</p>`;
                    }
                });
            }
        });
        
        // --- Initialization ---

        window.onload = function () {
            // è¨­å®šä»Šæ—¥æ—¥æœŸç‚ºé è¨­è¼¸å…¥å€¼
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('recordDate').value = today;
            document.getElementById('current-date').textContent = today.replace(/-/g, '/');

            DOM.recordForm.addEventListener('submit', saveRecord);
            
            // è¼‰å…¥ localStorage æ•¸æ“š
            loadRecords();

            // Set initial view
            showView('tracker');
            
            // Expose functions to the global scope for button click
            window.deleteRecord = deleteRecord;
        };
    </script>
</body>
</html>