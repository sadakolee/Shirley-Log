<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shirley FIP ä¹¾æ€§è…¹è†œç‚è¿½è¹¤</title>
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* è‡ªè¨‚æ¨£å¼ */
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fb; }
        .tab-button.active { border-bottom: 3px solid #10b981; font-weight: 600; color: #10b981; }
        .card { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06); }
        /* éš±è—é è¨­æ»¾å‹•æ¢ä¸¦ä½¿ç”¨è‡ªè¨‚æ»¾å‹•æ¢æ¨£å¼ (é‡å°æ”¯æ´çš„ç€è¦½å™¨) */
        .overflow-x-auto::-webkit-scrollbar { height: 8px; }
        .overflow-x-auto::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .overflow-x-auto::-webkit-scrollbar-track { background: #f1f5f9; }
    </style>
</head>
<body class="p-4 md:p-8">

    <header class="mb-8">
        <h1 class="text-3xl font-extrabold text-gray-800 mb-1">Shirley ä¹¾æ€§ FIP è¿½è¹¤</h1>
        <p class="text-sm text-gray-500">
            ç·¬å› è²“å¥³ | å‡ºç”Ÿæ—¥æœŸ: 2025å¹´1æœˆå°¾ (ç´„ <span id="cat-age"></span>) | ç¢ºè¨ºæ—¥æœŸ: 2025å¹´12æœˆ2æ—¥
        </p>
    </header>

    <!-- é ç±¤å°èˆª -->
    <div class="flex border-b border-gray-200 mb-6">
        <button id="tab-daily" class="tab-button active px-4 py-2 text-lg text-gray-600 transition duration-150 ease-in-out" onclick="switchTab('daily')">
            æ¯æ—¥å¥åº·è¿½è¹¤
        </button>
        <button id="tab-blood" class="tab-button px-4 py-2 text-lg text-gray-600 transition duration-150 ease-in-out" onclick="switchTab('blood')">
            é‡è¦è¡€æª¢è¨˜éŒ„
        </button>
    </div>

    <!-- æ¯æ—¥å¥åº·è¿½è¹¤é ç±¤å…§å®¹ -->
    <div id="daily-tracker" class="tab-content">

        <!-- è¨˜éŒ„è¡¨å–® -->
        <section class="card bg-white p-6 rounded-xl mb-8">
            <h2 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">ä»Šæ—¥è¨˜éŒ„ (<span id="today-date"></span>)</h2>
            <form id="daily-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">

                <!-- å¿…å‚™é …ç›®ï¼šæ—¥æœŸ -->
                <div class="col-span-1">
                    <label for="recordDate" class="block text-sm font-medium text-gray-700">é¸æ“‡è¨˜éŒ„æ—¥æœŸ</label>
                    <input type="date" id="recordDate" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-emerald-500 focus:ring-emerald-500 p-2 border">
                </div>
                
                <!-- æ ¸å¿ƒé …ç›®ï¼šé«”é‡ -->
                <div class="col-span-1">
                    <label for="weight" class="block text-sm font-medium text-gray-700">é«”é‡ (å…‹, g) <span class="text-xs text-red-500">*</span></label>
                    <input type="number" id="weight" step="1" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-emerald-500 focus:ring-emerald-500 p-2 border" placeholder="ä¾‹å¦‚: 4500">
                </div>

                <!-- æ ¸å¿ƒé …ç›®ï¼šç²¾ç¥ç‹€æ³ -->
                <div class="col-span-1">
                    <label for="mentalStatus" class="block text-sm font-medium text-gray-700">ç²¾ç¥ç‹€æ³ (Vet. å¿…å‚™)</label>
                    <select id="mentalStatus" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-emerald-500 focus:ring-emerald-500 p-2 border">
                        <option value="Normal">æ­£å¸¸æ´»èº</option>
                        <option value="Slightly Low">ç•¥ç‚ºä½è¿·</option>
                        <option value="Lethargic">æ˜é¡¯å—œç¡/ä½è¿· (Lethargy)</option>
                    </select>
                </div>

                <!-- æ ¸å¿ƒé …ç›®ï¼šé«”æº« -->
                <div class="col-span-1">
                    <label for="temperature" class="block text-sm font-medium text-gray-700">é«”æº« (â„ƒ) / ç™¼ç‡’èˆ‡å¦</label>
                    <input type="number" id="temperature" step="0.1" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-emerald-500 focus:ring-emerald-500 p-2 border" placeholder="ä¾‹å¦‚: 38.5">
                </div>

                <!-- é£²é£Ÿè¨˜éŒ„ -->
                <div class="col-span-3 border-t pt-4 mt-2">
                    <h3 class="text-base font-semibold text-gray-600 mb-2">é£²é£Ÿè¨˜éŒ„ (å…‹, g / æ¯«å‡, ml)</h3>
                    <div class="grid grid-cols-3 gap-4">
                        <div>
                            <label for="wetFood" class="block text-sm font-medium text-gray-700">æ¿•ç³§ä»½é‡ (g)</label>
                            <input type="number" id="wetFood" step="1" value="0" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border">
                        </div>
                        <div>
                            <label for="dryFood" class="block text-sm font-medium text-gray-700">ä¹¾ç³§ä»½é‡ (g)</label>
                            <input type="number" id="dryFood" step="1" value="0" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border">
                        </div>
                        <div>
                            <label for="emergencyFood" class="block text-sm font-medium text-gray-700">æ€¥æ•‘/å¼·åˆ¶é¤µé£Ÿé‡ (ml/g)</label>
                            <input type="number" id="emergencyFood" step="1" value="0" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border">
                        </div>
                    </div>
                </div>

                <!-- è—¥ç‰©/æ²»ç™‚è¨˜éŒ„ -->
                <div class="col-span-3 border-t pt-4 mt-2">
                    <h3 class="text-base font-semibold text-gray-600 mb-2">è—¥ç‰©åŠé‡é»ç—‡ç‹€è¨˜éŒ„</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <!-- FIP ä¸»è—¥ -->
                        <div class="col-span-2 md:col-span-1">
                            <label for="fipMedDose" class="block text-sm font-medium text-gray-700">FIP ä¸»è—¥ (ML) / æ™‚é–“</label>
                            <input type="text" id="fipMedDose" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border" placeholder="ä¾‹å¦‚: 0.8ml @ 20:00">
                        </div>
                        <!-- é–‹èƒƒè—¥ -->
                        <div>
                            <label for="appetiteStimulant" class="block text-sm font-medium text-gray-700">é–‹èƒƒè—¥ (Mirtazapine/cypro)</label>
                            <select id="appetiteStimulant" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border">
                                <option value="None">ç„¡</option>
                                <option value="L">å·¦è€³ (å¤–ç”¨)</option>
                                <option value="R">å³è€³ (å¤–ç”¨)</option>
                                <option value="Oral">å£æœ</option>
                            </select>
                        </div>
                        <!-- è²§è¡€è—¥ -->
                        <div>
                            <label for="anemiaMed" class="block text-sm font-medium text-gray-700">è²§è¡€è—¥ (Yes/No)</label>
                            <select id="anemiaMed" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border">
                                <option value="No">å¦</option>
                                <option value="Yes">æ˜¯</option>
                            </select>
                        </div>
                        <!-- å…ç–«åŠ›è—¥ -->
                        <div>
                            <label for="immunityMed" class="block text-sm font-medium text-gray-700">å…ç–«åŠ›è—¥ (Yes/No)</label>
                            <select id="immunityMed" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border">
                                <option value="No">å¦</option>
                                <option value="Yes">æ˜¯</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- ç¸é†«èªç‚ºå¿…é ˆçš„é …ç›® (ä¹¾æ€§FIPç‰¹åˆ¥é—œæ³¨) -->
                <div class="col-span-3 border-t pt-4 mt-2">
                    <h3 class="text-base font-semibold text-gray-600 mb-2">FIP ä¹¾æ€§ç—‡ç‹€ç´°ç¯€è¿½è¹¤ (Vet. ç‰¹åˆ¥æé†’)</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <!-- è¡Œå‹•/æ´»å‹•åŠ› -->
                        <div>
                            <label for="mobility" class="block text-sm font-medium text-gray-700">è¡Œå‹•/æ´»å‹•åŠ›</label>
                            <select id="mobility" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border">
                                <option value="Normal">æ­£å¸¸æ´»å‹•</option>
                                <option value="Reduced">æ´»å‹•æ¸›å°‘</option>
                                <option value="Ataxia">æ­¥æ…‹ä¸ç©©/å…±æ¿Ÿå¤±èª¿ (Neurological)</option>
                            </select>
                        </div>
                        <!-- æŠ½æ/ç¥ç¶“ç—‡ç‹€ -->
                        <div>
                            <label for="seizures" class="block text-sm font-medium text-gray-700">æŠ½æ/ç¥ç¶“ç—‡ç‹€</label>
                            <input type="text" id="seizures" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border" placeholder="ç„¡ / è¼•å¾®éœ‡é¡« / æŒçºŒæ™‚é–“">
                        </div>
                        <!-- é»ƒç–¸/çœ¼ç›ç—‡ç‹€ -->
                        <div>
                            <label for="jaundice" class="block text-sm font-medium text-gray-700">é»ƒç–¸ (Icterus) / çœ¼ç›ç—‡ç‹€</label>
                            <input type="text" id="jaundice" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border" placeholder="ç„¡ / è¼•å¾®é»ƒ / çœ¼ç›æ··æ¿/è‘¡è„è†œç‚">
                        </div>
                        <!-- è„«æ°´æƒ…æ³ -->
                        <div>
                            <label for="hydration" class="block text-sm font-medium text-gray-700">è„«æ°´æƒ…æ³ (çš®è†šå¼µåŠ›)</label>
                            <select id="hydration" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border">
                                <option value="Normal">æ­£å¸¸ (çš®è†šå›å½ˆå¿«)</option>
                                <option value="Mild">è¼•å¾® (å›å½ˆæ…¢)</option>
                                <option value="Severe">åš´é‡ (æ˜é¡¯è„«æ°´)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- å‚™è¨» -->
                <div class="col-span-3">
                    <label for="notes" class="block text-sm font-medium text-gray-700">å…¶ä»–å‚™è¨» / æ’æ³„ç‹€æ³</label>
                    <textarea id="notes" rows="3" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border" placeholder="ä¾‹å¦‚: ä»Šå¤©é£Ÿæ…¾æ˜é¡¯æå‡, å°¿é‡æ­£å¸¸, å¤§ä¾¿åè»Ÿã€‚"></textarea>
                </div>

                <!-- æäº¤æŒ‰éˆ• -->
                <div class="col-span-3">
                    <button type="submit" class="w-full inline-flex justify-center rounded-lg border border-transparent bg-emerald-600 py-3 text-lg font-medium text-white shadow-md hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:ring-offset-2 transition duration-150 ease-in-out">
                        ğŸ’¾ å„²å­˜ä»Šæ—¥å¥åº·è¨˜éŒ„
                    </button>
                    <div id="message-box" class="mt-2 text-center text-sm font-medium hidden p-2 rounded-lg"></div>
                </div>
            </form>
        </section>

        <!-- è¨˜éŒ„ç¸½çµè¡¨æ ¼ -->
        <section class="card bg-white p-6 rounded-xl">
            <h2 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">æ­·å²è¨˜éŒ„ç¸½çµ</h2>
            <!-- è¡¨æ ¼å®¹å™¨ï¼Œç”¨æ–¼éŸ¿æ‡‰å¼æ»¾å‹• -->
            <div class="overflow-x-auto">
                <table id="summary-table" class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sticky left-0 bg-gray-50">æ—¥æœŸ</th>
                            <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">é«”é‡ (g)</th>
                            <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">è®ŠåŒ–</th>
                            <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">é«”æº« (â„ƒ)</th>
                            <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ç²¾ç¥</th>
                            <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">FIPè—¥ (ML/Time)</th>
                            <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">é–‹èƒƒè—¥</th>
                            <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ç¥ç¶“/æŠ½æ</th>
                            <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">é£²é£Ÿç¸½é‡(g/ml)</th>
                            <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="summary-body" class="bg-white divide-y divide-gray-200">
                        <!-- è¨˜éŒ„å°‡ç”± JavaScript æ¸²æŸ“ -->
                    </tbody>
                </table>
                <p id="no-records-message" class="text-center text-gray-500 p-4 hidden">æš«ç„¡è¨˜éŒ„ï¼Œè«‹å…ˆè¼¸å…¥æ•¸æ“šã€‚</p>
            </div>
        </section>
    </div>

    <!-- è¡€æª¢å ±å‘Šè¨˜éŒ„é ç±¤å…§å®¹ -->
    <div id="blood-report" class="tab-content hidden">
        <section class="card bg-white p-6 rounded-xl">
            <h2 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">FIP é—œéµè¡€æª¢æŒ‡æ¨™è¿½è¹¤ (è«‹è¼¸å…¥æœ€æ–°å ±å‘Šæ•¸æ“š)</h2>
            <p class="text-sm text-gray-500 mb-4">æ ¹æ“šç¸é†«ç¶“é©—ï¼Œä¹¾æ€§FIPæ²»ç™‚æœŸè«‹ç‰¹åˆ¥é—œæ³¨ä»¥ä¸‹æŒ‡æ¨™ï¼š</p>
            <form id="blood-form" class="grid grid-cols-1 md:grid-cols-2 gap-6">

                <div class="col-span-1">
                    <label for="reportDate" class="block text-sm font-medium text-gray-700">å ±å‘Šæ—¥æœŸ <span class="text-xs text-red-500">*</span></label>
                    <input type="date" id="reportDate" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border">
                </div>
                <div class="col-span-1">
                    <label for="totalProtein" class="block text-sm font-medium text-gray-700">ç¸½è›‹ç™½ (Total Protein, TP) (g/dL)</label>
                    <input type="number" id="totalProtein" step="0.1" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border">
                </div>
                <div class="col-span-1">
                    <label for="albumin" class="block text-sm font-medium text-gray-700">ç™½è›‹ç™½ (Albumin, ALB) (g/dL)</label>
                    <input type="number" id="albumin" step="0.1" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border">
                </div>
                <div class="col-span-1">
                    <label for="globulin" class="block text-sm font-medium text-gray-700">çƒè›‹ç™½ (Globulin, GLOB) (g/dL)</label>
                    <input type="number" id="globulin" step="0.1" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border">
                </div>
                <div class="col-span-1">
                    <label class="block text-sm font-medium text-gray-700">ç™½è›‹ç™½/çƒè›‹ç™½æ¯”å€¼ (A:G Ratio)</label>
                    <p id="agRatioDisplay" class="mt-1 p-2 text-lg font-bold text-gray-600 border border-gray-200 rounded-lg bg-gray-50">--</p>
                    <input type="hidden" id="agRatio" value="">
                </div>
                <div class="col-span-1">
                    <label for="hct" class="block text-sm font-medium text-gray-700">è¡€å®¹æ¯” (Hematocrit, HCT) (%) <span class="text-xs text-red-500">(è²§è¡€æŒ‡æ¨™)</span></label>
                    <input type="number" id="hct" step="0.1" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border">
                </div>

                <div class="col-span-2">
                    <label for="bloodNotes" class="block text-sm font-medium text-gray-700">è¡€æª¢å‚™è¨»</label>
                    <textarea id="bloodNotes" rows="2" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border" placeholder="å…¶ä»–é‡è¦æŒ‡æ¨™å¦‚ï¼šé»ƒç–¸æŒ‡æ•¸ã€è‚è…åŠŸèƒ½æ˜¯å¦ç•°å¸¸ã€‚"></textarea>
                </div>
                
                <div class="col-span-2">
                    <button type="submit" class="w-full inline-flex justify-center rounded-lg border border-transparent bg-blue-600 py-3 text-lg font-medium text-white shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-150 ease-in-out">
                        ğŸ’¾ å„²å­˜è¡€æª¢å ±å‘Šè¨˜éŒ„
                    </button>
                    <div id="blood-message-box" class="mt-2 text-center text-sm font-medium hidden p-2 rounded-lg"></div>
                </div>
            </form>

            <h3 class="text-lg font-semibold text-gray-700 mt-8 mb-4 border-b pb-2">æ­·å²è¡€æª¢å ±å‘Š</h3>
            <div class="overflow-x-auto">
                <table id="blood-summary-table" class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">å ±å‘Šæ—¥æœŸ</th>
                            <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">TP</th>
                            <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ALB</th>
                            <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">GLOB</th>
                            <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">A:G Ratio</th>
                            <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">HCT (%)</th>
                            <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">å‚™è¨»</th>
                            <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="blood-summary-body" class="bg-white divide-y divide-gray-200">
                        <!-- è¨˜éŒ„å°‡ç”± JavaScript æ¸²æŸ“ -->
                    </tbody>
                </table>
            </div>
        </section>
    </div>

    <!-- JavaScript é‚è¼¯ -->
    <script>
        // è¨­å®šä»Šå¤©çš„æ—¥æœŸç‚ºé è¨­å€¼
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('recordDate').value = today;
        document.getElementById('today-date').textContent = today;

        // è²“å’ªç”Ÿæ—¥å’Œç¢ºè¨ºæ—¥
        const CAT_DOB = new Date('2025-01-31');
        const DIAGNOSIS_DATE = new Date('2025-12-02');

        /**
         * é¡¯ç¤ºè¨Šæ¯
         * @param {string} message - è¨Šæ¯å…§å®¹
         * @param {string} type - é¡å‹ ('success' or 'error')
         * @param {string} boxId - è¨Šæ¯æ¡†ID
         */
        function showMessage(message, type, boxId = 'message-box') {
            const box = document.getElementById(boxId);
            box.textContent = message;
            box.className = `mt-2 text-center text-sm font-medium p-2 rounded-lg ${type === 'success' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`;
            box.classList.remove('hidden');
            setTimeout(() => {
                box.classList.add('hidden');
            }, 3000);
        }

        // --- é ç±¤åˆ‡æ›é‚è¼¯ ---
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.tab-button').forEach(el => el.classList.remove('active'));

            document.getElementById(`${tabName}-tracker`).classList.remove('hidden');
            document.getElementById(`tab-${tabName}`).classList.add('active');

            // ç¢ºä¿åˆ‡æ›å¾Œé‡ç¹ªè¡¨æ ¼
            if (tabName === 'daily') {
                renderDailyRecords();
            } else if (tabName === 'blood') {
                renderBloodReports();
            }
        }

        // --- è²“å’ªå¹´é½¡è¨ˆç®— ---
        function calculateAgeAndDay() {
            const today = new Date();
            const ageMs = today - CAT_DOB;
            const ageDays = Math.floor(ageMs / (1000 * 60 * 60 * 24));
            const ageMonths = Math.floor(ageDays / 30.44); // Approximate month
            
            let ageText = '';
            if (ageMonths > 1) {
                ageText = `${ageMonths} å€‹æœˆ`;
            } else {
                ageText = `${ageDays} å¤©`;
            }

            const diagnosisMs = today - DIAGNOSIS_DATE;
            const diagnosisDays = Math.floor(diagnosisMs / (1000 * 60 * 60 * 24)) + 1; // +1 for Day 1 is 2025-12-02

            document.getElementById('cat-age').textContent = `${ageText} (FIPæ²»ç™‚ç¬¬ ${diagnosisDays} å¤©)`;
        }

        // --- æ¯æ—¥å¥åº·è¿½è¹¤é‚è¼¯ ---

        /**
         * å¾ localStorage è¼‰å…¥æ¯æ—¥æ•¸æ“š
         * @returns {Object} æ¯æ—¥è¨˜éŒ„å°è±¡
         */
        function loadDailyRecords() {
            try {
                const data = localStorage.getItem('shirleyFIPRecords');
                return data ? JSON.parse(data) : {};
            } catch (e) {
                console.error("ç„¡æ³•è¼‰å…¥æ¯æ—¥è¨˜éŒ„:", e);
                return {};
            }
        }

        /**
         * å„²å­˜æ¯æ—¥æ•¸æ“šåˆ° localStorage
         * @param {Object} data - è¦å„²å­˜çš„æ¯æ—¥è¨˜éŒ„å°è±¡
         */
        function saveDailyRecords(data) {
            try {
                localStorage.setItem('shirleyFIPRecords', JSON.stringify(data));
            } catch (e) {
                console.error("ç„¡æ³•å„²å­˜æ¯æ—¥è¨˜éŒ„:", e);
            }
        }

        document.getElementById('daily-form').addEventListener('submit', function(e) {
            e.preventDefault();

            const date = document.getElementById('recordDate').value;
            const weight = parseFloat(document.getElementById('weight').value);

            if (!date || isNaN(weight)) {
                showMessage('è«‹è¼¸å…¥æ—¥æœŸå’Œé«”é‡ (å…‹)', 'error');
                return;
            }

            const newRecord = {
                weight: weight,
                temperature: parseFloat(document.getElementById('temperature').value) || null,
                mentalStatus: document.getElementById('mentalStatus').value,
                wetFood: parseFloat(document.getElementById('wetFood').value) || 0,
                dryFood: parseFloat(document.getElementById('dryFood').value) || 0,
                emergencyFood: parseFloat(document.getElementById('emergencyFood').value) || 0,
                fipMedDose: document.getElementById('fipMedDose').value,
                appetiteStimulant: document.getElementById('appetiteStimulant').value,
                anemiaMed: document.getElementById('anemiaMed').value,
                immunityMed: document.getElementById('immunityMed').value,
                mobility: document.getElementById('mobility').value,
                seizures: document.getElementById('seizures').value,
                jaundice: document.getElementById('jaundice').value,
                hydration: document.getElementById('hydration').value,
                notes: document.getElementById('notes').value,
                timestamp: new Date().toISOString()
            };

            const allRecords = loadDailyRecords();
            allRecords[date] = newRecord;
            saveDailyRecords(allRecords);
            showMessage('âœ… æ¯æ—¥è¨˜éŒ„å„²å­˜æˆåŠŸï¼', 'success');
            
            // é‡ç¹ªç¸½çµè¡¨æ ¼
            renderDailyRecords();
        });

        /**
         * æ¸²æŸ“æ¯æ—¥è¨˜éŒ„ç¸½çµè¡¨æ ¼
         */
        function renderDailyRecords() {
            const allRecords = loadDailyRecords();
            const dates = Object.keys(allRecords).sort().reverse(); // ç”±è¿‘åˆ°é æ’åº
            const body = document.getElementById('summary-body');
            body.innerHTML = '';
            
            if (dates.length === 0) {
                document.getElementById('no-records-message').classList.remove('hidden');
                return;
            }
            document.getElementById('no-records-message').classList.add('hidden');


            let previousWeight = null;

            // ç”±æ–¼è¡¨æ ¼æ˜¯å¾è¿‘åˆ°é ï¼Œä½†é«”é‡è®ŠåŒ–éœ€è¦å¾é åˆ°è¿‘è¨ˆç®—ï¼Œæ‰€ä»¥æˆ‘å€‘éœ€è¦å€’è‘—è™•ç†æ•¸æ“š
            const reversedDates = Object.keys(allRecords).sort(); 
            const recordsWithChange = {};

            reversedDates.forEach((date, index) => {
                const record = allRecords[date];
                let weightChange = 0;
                let colorClass = 'text-gray-500';

                if (index > 0) {
                    const prevDate = reversedDates[index - 1];
                    const prevWeight = allRecords[prevDate].weight;
                    weightChange = record.weight - prevWeight;

                    if (weightChange > 0) {
                        colorClass = 'text-green-600 font-bold';
                    } else if (weightChange < 0) {
                        colorClass = 'text-red-600 font-bold';
                    }
                }
                
                recordsWithChange[date] = {
                    ...record,
                    weightChange: weightChange,
                    colorClass: colorClass
                };
            });

            // ç¾åœ¨æˆ‘å€‘å¾è¿‘åˆ°é æ¸²æŸ“è¡¨æ ¼
            const finalDates = Object.keys(recordsWithChange).sort().reverse();

            finalDates.forEach(date => {
                const record = recordsWithChange[date];
                const totalFood = record.wetFood + record.dryFood + record.emergencyFood;
                const changeSymbol = record.weightChange > 0 ? 'â–²' : (record.weightChange < 0 ? 'â–¼' : 'â–¬');
                const tempDisplay = record.temperature ? `${record.temperature}â„ƒ` : 'ç„¡';

                // é«”é‡è®ŠåŒ–å–®å…ƒæ ¼å…§å®¹
                const weightChangeCell = `
                    <span class="${record.colorClass}">
                        ${record.weightChange !== 0 ? changeSymbol : ''} ${record.weightChange.toFixed(0)} g
                    </span>
                `;
                
                // ç²¾ç¥ç‹€æ³é¡è‰²æ¨™ç¤º
                let mentalColor = 'text-gray-600';
                if (record.mentalStatus === 'Lethargic') mentalColor = 'text-red-600 font-bold';
                if (record.mentalStatus === 'Normal') mentalColor = 'text-green-600';


                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-100 transition duration-100';
                row.innerHTML = `
                    <td class="px-3 py-3 whitespace-nowrap text-sm font-medium text-gray-900 sticky left-0 bg-white">${date}</td>
                    <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-700">${record.weight} g</td>
                    <td class="px-3 py-3 whitespace-nowrap text-sm">${record.weightChange !== 0 ? weightChangeCell : '--'}</td>
                    <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-700">${tempDisplay}</td>
                    <td class="px-3 py-3 whitespace-nowrap text-sm ${mentalColor}">${record.mentalStatus}</td>
                    <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-700">${record.fipMedDose || 'ç„¡'}</td>
                    <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-700">${record.appetiteStimulant !== 'None' ? record.appetiteStimulant : 'ç„¡'}</td>
                    <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-700">${record.seizures || 'ç„¡'}</td>
                    <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-700">${totalFood}</td>
                    <td class="px-3 py-3 whitespace-nowrap text-right text-sm font-medium">
                        <button onclick="deleteDailyRecord('${date}')" class="text-red-500 hover:text-red-700 text-xs">åˆªé™¤</button>
                    </td>
                `;
                body.appendChild(row);

                previousWeight = record.weight;
            });
        }

        /**
         * åˆªé™¤å–®æ—¥è¨˜éŒ„
         * @param {string} date - è¦åˆªé™¤çš„æ—¥æœŸ
         */
        function deleteDailyRecord(date) {
            if (confirm(`ç¢ºå®šè¦åˆªé™¤ ${date} çš„è¨˜éŒ„å—ï¼Ÿ`)) {
                const allRecords = loadDailyRecords();
                delete allRecords[date];
                saveDailyRecords(allRecords);
                renderDailyRecords();
                showMessage('è¨˜éŒ„å·²åˆªé™¤ã€‚', 'success');
            }
        }


        // --- è¡€æª¢å ±å‘Šé‚è¼¯ ---

        /**
         * å¾ localStorage è¼‰å…¥è¡€æª¢æ•¸æ“š
         * @returns {Object} è¡€æª¢è¨˜éŒ„å°è±¡ (ä»¥æ—¥æœŸç‚º key)
         */
        function loadBloodReports() {
            try {
                const data = localStorage.getItem('shirleyBloodReports');
                return data ? JSON.parse(data) : {};
            } catch (e) {
                console.error("ç„¡æ³•è¼‰å…¥è¡€æª¢å ±å‘Š:", e);
                return {};
            }
        }

        /**
         * å„²å­˜è¡€æª¢æ•¸æ“šåˆ° localStorage
         * @param {Object} data - è¦å„²å­˜çš„è¡€æª¢è¨˜éŒ„å°è±¡
         */
        function saveBloodReports(data) {
            try {
                localStorage.setItem('shirleyBloodReports', JSON.stringify(data));
            } catch (e) {
                console.error("ç„¡æ³•å„²å­˜è¡€æª¢å ±å‘Š:", e);
            }
        }

        // A:G Ratio è‡ªå‹•è¨ˆç®—
        document.getElementById('albumin').addEventListener('input', updateAGRatio);
        document.getElementById('globulin').addEventListener('input', updateAGRatio);

        function updateAGRatio() {
            const alb = parseFloat(document.getElementById('albumin').value);
            const glob = parseFloat(document.getElementById('globulin').value);
            const ratioDisplay = document.getElementById('agRatioDisplay');
            const ratioInput = document.getElementById('agRatio');

            if (alb > 0 && glob > 0) {
                const ratio = (alb / glob).toFixed(2);
                ratioDisplay.textContent = ratio;
                ratioInput.value = ratio;
                if (ratio < 0.6) {
                    ratioDisplay.classList.remove('text-green-600');
                    ratioDisplay.classList.add('text-red-600');
                } else {
                    ratioDisplay.classList.remove('text-red-600');
                    ratioDisplay.classList.add('text-green-600');
                }
            } else {
                ratioDisplay.textContent = '--';
                ratioInput.value = '';
                ratioDisplay.classList.remove('text-red-600', 'text-green-600');
            }
        }

        document.getElementById('blood-form').addEventListener('submit', function(e) {
            e.preventDefault();

            const date = document.getElementById('reportDate').value;
            if (!date) {
                showMessage('è«‹è¼¸å…¥å ±å‘Šæ—¥æœŸ', 'error', 'blood-message-box');
                return;
            }
            
            // ç¢ºä¿ A:G Ratio å·²è¨ˆç®—
            updateAGRatio();

            const newReport = {
                reportDate: date,
                totalProtein: parseFloat(document.getElementById('totalProtein').value) || null,
                albumin: parseFloat(document.getElementById('albumin').value) || null,
                globulin: parseFloat(document.getElementById('globulin').value) || null,
                agRatio: parseFloat(document.getElementById('agRatio').value) || null,
                hct: parseFloat(document.getElementById('hct').value) || null,
                bloodNotes: document.getElementById('bloodNotes').value,
                timestamp: new Date().toISOString()
            };

            const allReports = loadBloodReports();
            allReports[date] = newReport; // ä½¿ç”¨æ—¥æœŸä½œç‚ºå”¯ä¸€ key
            saveBloodReports(allReports);
            showMessage('âœ… è¡€æª¢å ±å‘Šå„²å­˜æˆåŠŸï¼', 'success', 'blood-message-box');
            
            // é‡ç¹ªè¡€æª¢è¡¨æ ¼
            renderBloodReports();
        });

        /**
         * æ¸²æŸ“è¡€æª¢å ±å‘Šç¸½çµè¡¨æ ¼
         */
        function renderBloodReports() {
            const allReports = loadBloodReports();
            const dates = Object.keys(allReports).sort().reverse(); // ç”±è¿‘åˆ°é æ’åº
            const body = document.getElementById('blood-summary-body');
            body.innerHTML = '';
            
            dates.forEach(date => {
                const report = allReports[date];

                // A:G Ratio é¡è‰²æ¨™ç¤º: ä¹¾æ€§FIPé€šå¸¸A:G Ratioæœƒå¾ˆä½ (<0.6)ï¼Œéœ€è¦ç‰¹åˆ¥é—œæ³¨
                let ratioClass = 'text-gray-700';
                if (report.agRatio && report.agRatio < 0.6) {
                    ratioClass = 'text-red-600 font-bold';
                } else if (report.agRatio && report.agRatio >= 0.8) {
                    ratioClass = 'text-green-600 font-bold';
                }

                // HCT é¡è‰²æ¨™ç¤º: ä½æ–¼ 25% éœ€è¦è­¦æƒ•è²§è¡€
                let hctClass = 'text-gray-700';
                if (report.hct && report.hct < 25) {
                    hctClass = 'text-red-600 font-bold';
                } else if (report.hct && report.hct > 30) {
                     hctClass = 'text-green-600';
                }


                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-100 transition duration-100';
                row.innerHTML = `
                    <td class="px-3 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${report.reportDate}</td>
                    <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-700">${report.totalProtein !== null ? report.totalProtein.toFixed(1) : '--'}</td>
                    <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-700">${report.albumin !== null ? report.albumin.toFixed(1) : '--'}</td>
                    <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-700">${report.globulin !== null ? report.globulin.toFixed(1) : '--'}</td>
                    <td class="px-3 py-3 whitespace-nowrap text-sm ${ratioClass}">${report.agRatio !== null ? report.agRatio.toFixed(2) : '--'}</td>
                    <td class="px-3 py-3 whitespace-nowrap text-sm ${hctClass}">${report.hct !== null ? report.hct.toFixed(1) : '--'}</td>
                    <td class="px-3 py-3 text-sm text-gray-700 max-w-xs truncate">${report.bloodNotes || 'ç„¡å‚™è¨»'}</td>
                    <td class="px-3 py-3 whitespace-nowrap text-right text-sm font-medium">
                        <button onclick="deleteBloodReport('${date}')" class="text-red-500 hover:text-red-700 text-xs">åˆªé™¤</button>
                    </td>
                `;
                body.appendChild(row);
            });
        }

        /**
         * åˆªé™¤è¡€æª¢å ±å‘Š
         * @param {string} date - è¦åˆªé™¤çš„å ±å‘Šæ—¥æœŸ
         */
        function deleteBloodReport(date) {
            if (confirm(`ç¢ºå®šè¦åˆªé™¤ ${date} çš„è¡€æª¢å ±å‘Šå—ï¼Ÿ`)) {
                const allReports = loadBloodReports();
                delete allReports[date];
                saveBloodReports(allReports);
                renderBloodReports();
                showMessage('è¡€æª¢å ±å‘Šå·²åˆªé™¤ã€‚', 'success', 'blood-message-box');
            }
        }


        // --- å•Ÿå‹•åˆå§‹åŒ– ---
        document.addEventListener('DOMContentLoaded', () => {
            calculateAgeAndDay();
            renderDailyRecords();
            renderBloodReports();
            // åˆå§‹åŒ– A:G Ratio é¡¯ç¤º
            updateAGRatio(); 
        });

    </script>
</body>
</html>